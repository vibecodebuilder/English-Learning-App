<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WordFlip</title>
<style>
html, body {
  background: #1a0f14 !important;
  background-color: #1a0f14 !important;
  color: #f0e8d5 !important;
  font-family: Georgia, 'Times New Roman', serif !important;
  margin: 0 !important;
  padding: 0 !important;
  min-height: 100vh !important;
}

* { box-sizing: border-box !important; }

#app {
  background: #1a0f14;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 0 16px 80px;
  font-family: Georgia, 'Times New Roman', serif;
  color: #f0e8d5;
  position: relative;
}

/* Ambient background glow */
#app::before {
  content: '';
  position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background:
    radial-gradient(ellipse 70% 50% at 15% 15%, rgba(60,160,140,0.12) 0%, transparent 60%),
    radial-gradient(ellipse 60% 60% at 85% 85%, rgba(200,155,50,0.09) 0%, transparent 60%),
    radial-gradient(ellipse 80% 40% at 50% 0%, rgba(80,120,200,0.07) 0%, transparent 55%);
}

.inner {
  position: relative; z-index: 1;
  width: 100%; max-width: 680px;
  display: flex; flex-direction: column; align-items: center;
}

/* ── HEADER ── */
.header {
  width: 100%;
  display: flex; justify-content: space-between; align-items: center;
  padding: 28px 0 20px;
}

.logo {
  font-size: 2rem; font-weight: bold;
  color: #d4a843; letter-spacing: -0.02em;
  font-family: Georgia, serif;
}
.logo-em { font-style: italic; font-weight: normal; color: rgba(240,232,213,0.5); }

.lv-row { display: flex; gap: 6px; }
.lv-btn {
  font-family: 'Courier New', monospace;
  font-size: 11px; font-weight: bold; letter-spacing: 1.5px;
  padding: 6px 14px; border-radius: 999px;
  border: 1.5px solid rgba(255,255,255,0.12);
  background: rgba(255,255,255,0.06);
  color: rgba(255,255,255,0.35);
  cursor: pointer; transition: all 0.2s;
}
.lv-btn:hover { color: #f0e8d5; background: rgba(255,255,255,0.12); }
.lv-btn.a1on { background: rgba(100,180,245,0.18); border-color: #6ab4f5; color: #6ab4f5; }
.lv-btn.b1on { background: rgba(212,168,67,0.18);  border-color: #d4a843; color: #d4a843; }
.lv-btn.c1on { background: rgba(210,100,100,0.18); border-color: #e07878; color: #e07878; }

/* ── PROGRESS ── */
.prog { width: 100%; margin-bottom: 24px; }
.prog-top { display: flex; justify-content: space-between; margin-bottom: 8px; }
.prog-lbl { font-family: 'Courier New', monospace; font-size: 10px; letter-spacing: 1.5px; text-transform: uppercase; color: rgba(255,255,255,0.28); }
.prog-track { height: 5px; background: rgba(255,255,255,0.08); border-radius: 99px; position: relative; }
.prog-bar {
  height: 100%; border-radius: 99px;
  background: linear-gradient(90deg, #4db8a0, #d4a843);
  transition: width 0.6s ease; position: relative;
}
.prog-bar::after {
  content: '';
  position: absolute; right: -5px; top: 50%; transform: translateY(-50%);
  width: 11px; height: 11px; border-radius: 50%;
  background: #e8c870; box-shadow: 0 0 12px 4px rgba(212,168,67,0.65);
}

/* ── SCENE / CARD ── */
.scene {
  width: 100%; height: 400px;
  perspective: 1400px; margin-bottom: 24px; cursor: pointer;
}

.card {
  width: 100%; height: 100%;
  position: relative; transform-style: preserve-3d;
  transition: transform 0.7s cubic-bezier(0.4,0,0.2,1);
}
.card.flipped { transform: rotateY(180deg); }

.face {
  position: absolute; inset: 0; border-radius: 24px;
  backface-visibility: hidden; -webkit-backface-visibility: hidden;
  display: flex; flex-direction: column;
  justify-content: center; align-items: center;
  padding: 40px 48px; text-align: center; overflow: hidden;
}

/* FRONT — warm cream paper */
.front {
  background: linear-gradient(148deg, #f9f3e5 0%, #ede4cf 100%);
  box-shadow: 0 40px 80px rgba(0,0,0,0.7), 0 10px 30px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.9);
}
.front::before {
  content: ''; position: absolute; inset: 0; border-radius: 24px; pointer-events: none;
  background-image: repeating-linear-gradient(0deg, transparent 0px, transparent 30px, rgba(26,20,8,0.055) 30px, rgba(26,20,8,0.055) 31px);
}
.front::after {
  content: ''; position: absolute; top: 20px; left: 20px;
  width: 30px; height: 30px;
  border-top: 2px solid rgba(26,20,8,0.18); border-left: 2px solid rgba(26,20,8,0.18);
  border-radius: 3px 0 0 0;
}
.flip-tip {
  position: absolute; bottom: 14px; right: 18px;
  font-family: 'Courier New', monospace; font-size: 9px;
  letter-spacing: 1px; text-transform: uppercase; color: rgba(26,20,8,0.25);
}

/* BACK — deep ocean */
.back {
  transform: rotateY(180deg);
  background: linear-gradient(148deg, #0f2235 0%, #091626 100%);
  box-shadow: 0 40px 80px rgba(0,0,0,0.75), 0 0 0 1px rgba(77,184,160,0.12);
}
.back::before {
  content: ''; position: absolute; inset: 0; border-radius: 24px; pointer-events: none;
  background:
    radial-gradient(ellipse 65% 55% at 25% 30%, rgba(77,184,160,0.14) 0%, transparent 65%),
    radial-gradient(ellipse 55% 50% at 80% 80%, rgba(212,168,67,0.08) 0%, transparent 65%);
}
.back::after {
  content: ''; position: absolute; bottom: 20px; right: 20px;
  width: 30px; height: 30px;
  border-bottom: 2px solid rgba(77,184,160,0.28); border-right: 2px solid rgba(77,184,160,0.28);
  border-radius: 0 0 3px 0;
}

/* Badge */
.badge {
  font-family: 'Courier New', monospace; font-size: 10px;
  font-weight: bold; letter-spacing: 2px; text-transform: uppercase;
  padding: 4px 12px; border-radius: 99px; margin-bottom: 18px;
  position: relative; z-index: 1;
}
.ba { background: rgba(100,180,245,0.16); color: #6ab4f5; border: 1px solid rgba(100,180,245,0.35); }
.bb { background: rgba(212,168,67,0.16);  color: #d4a843; border: 1px solid rgba(212,168,67,0.35); }
.bc { background: rgba(210,100,100,0.16); color: #e07878; border: 1px solid rgba(210,100,100,0.35); }

/* Sentence — clickable words */
.sent-en {
  font-family: Georgia, serif; font-size: 30px; font-weight: bold;
  color: #1c1510; line-height: 1.5;
  display: flex; flex-wrap: wrap; justify-content: center;
  gap: 0 3px; position: relative; z-index: 1; margin-bottom: 8px;
}

.w {
  display: inline-block; padding: 3px 5px; margin: 2px 1px;
  border-radius: 8px; cursor: pointer;
  transition: background 0.15s, transform 0.15s, box-shadow 0.15s;
  user-select: none;
}
.w:hover {
  background: rgba(28,21,10,0.12);
  transform: translateY(-3px);
  box-shadow: 0 5px 12px rgba(28,21,10,0.14);
}
.w.lit {
  background: rgba(212,168,67,0.3);
  color: #4a2e00;
  transform: translateY(-3px) scale(1.07);
  box-shadow: 0 6px 18px rgba(212,168,67,0.3);
}

.tap-hint {
  font-family: 'Courier New', monospace; font-size: 9px;
  color: rgba(28,21,10,0.38); letter-spacing: 1.5px; text-transform: uppercase;
  margin-bottom: 12px; position: relative; z-index: 1;
}

/* Play button */
.play-btn {
  display: inline-flex; align-items: center; gap: 7px;
  font-family: 'Courier New', monospace; font-size: 10px;
  letter-spacing: 1px; text-transform: uppercase;
  padding: 8px 18px; border-radius: 99px;
  border: 1.5px solid rgba(28,21,10,0.2);
  background: rgba(28,21,10,0.06); color: rgba(28,21,10,0.5);
  cursor: pointer; transition: all 0.2s; position: relative; z-index: 2; margin-bottom: 14px;
}
.play-btn:hover { background: rgba(28,21,10,0.13); color: rgba(28,21,10,0.82); transform: translateY(-2px); }
.play-btn.on { background: rgba(212,168,67,0.2); border-color: rgba(212,168,67,0.55); color: rgba(90,50,0,0.95); animation: pglow 0.9s ease infinite; }
@keyframes pglow { 0%,100% { box-shadow: 0 0 0 0 rgba(212,168,67,0.55); } 50% { box-shadow: 0 0 0 10px rgba(212,168,67,0); } }
.play-btn svg { width: 12px; height: 12px; fill: currentColor; }

/* Serbian on front */
.sr-front { display: flex; flex-direction: column; align-items: center; position: relative; z-index: 1; }
.sr-rule { width: 48px; height: 1px; background: linear-gradient(90deg, transparent, rgba(28,21,10,0.2), transparent); margin-bottom: 8px; }
.sr-label { font-family: 'Courier New', monospace; font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: rgba(28,21,10,0.32); margin-bottom: 4px; }
.sr-text { font-family: Georgia, serif; font-size: 17px; font-style: italic; color: rgba(28,21,10,0.45); line-height: 1.45; }

/* Back face content */
.back-lbl {
  font-family: 'Courier New', monospace; font-size: 10px;
  letter-spacing: 2px; text-transform: uppercase;
  padding: 4px 12px; border-radius: 99px; margin-bottom: 16px;
  background: rgba(77,184,160,0.14); color: #7ecfbb;
  border: 1px solid rgba(77,184,160,0.25); position: relative; z-index: 1;
}
.sent-sr {
  font-family: Georgia, serif; font-size: 26px; font-weight: bold;
  color: #7ecfbb; line-height: 1.5; margin-bottom: 16px; position: relative; z-index: 1;
}
.gram-note {
  font-family: 'Courier New', monospace; font-size: 10px;
  color: rgba(212,168,67,0.72); letter-spacing: 0.5px;
  background: rgba(212,168,67,0.08); border: 1px solid rgba(212,168,67,0.18);
  padding: 8px 18px; border-radius: 99px; line-height: 1.6;
  max-width: 380px; position: relative; z-index: 1;
}

/* ── CONTROLS ── */
.controls { width: 100%; display: flex; gap: 10px; align-items: stretch; margin-bottom: 16px; }

.nav-btn {
  width: 50px; min-width: 50px; border-radius: 50%;
  background: rgba(255,255,255,0.07); border: 1.5px solid rgba(255,255,255,0.1);
  color: rgba(255,255,255,0.35); font-size: 18px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; transition: all 0.2s;
}
.nav-btn:hover { background: rgba(255,255,255,0.14); color: #f0e8d5; transform: scale(1.08); }

.rate-btn {
  flex: 1; padding: 14px 8px; border-radius: 18px; cursor: pointer;
  display: flex; flex-direction: column; align-items: center; gap: 4px;
  transition: transform 0.2s, box-shadow 0.2s;
}
.rate-btn:hover { transform: translateY(-4px); }
.r-ico { font-size: 22px; line-height: 1; }
.r-lbl { font-size: 13px; font-weight: bold; font-family: Georgia, serif; }
.r-sub { font-size: 9px; letter-spacing: 1px; font-family: 'Courier New', monospace; opacity: 0.5; }

.r-hard { background: rgba(210,90,90,0.13); border: 1.5px solid rgba(210,90,90,0.28); color: #e09090; }
.r-hard:hover { background: rgba(210,90,90,0.22); box-shadow: 0 12px 30px rgba(210,90,90,0.22); }
.r-ok   { background: rgba(212,168,67,0.13);  border: 1.5px solid rgba(212,168,67,0.28);  color: #e8c870; }
.r-ok:hover   { background: rgba(212,168,67,0.22);  box-shadow: 0 12px 30px rgba(212,168,67,0.22); }
.r-good { background: rgba(77,184,160,0.13);  border: 1.5px solid rgba(77,184,160,0.28);  color: #7ecfbb; }
.r-good:hover { background: rgba(77,184,160,0.22);  box-shadow: 0 12px 30px rgba(77,184,160,0.22); }

/* ── STATS ── */
.stats { width: 100%; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
.s-box { border-radius: 18px; padding: 18px 12px; text-align: center; background: rgba(255,255,255,0.04); transition: transform 0.2s; }
.s-box:hover { transform: translateY(-3px); }
.s-box:nth-child(1) { border: 1.5px solid rgba(210,90,90,0.18); }
.s-box:nth-child(2) { border: 1.5px solid rgba(212,168,67,0.18); }
.s-box:nth-child(3) { border: 1.5px solid rgba(77,184,160,0.18); }
.s-num { font-family: Georgia, serif; font-size: 36px; font-weight: bold; line-height: 1; display: block; margin-bottom: 6px; }
.s-box:nth-child(1) .s-num { color: #e09090; }
.s-box:nth-child(2) .s-num { color: #e8c870; }
.s-box:nth-child(3) .s-num { color: #7ecfbb; }
.s-lbl { font-family: 'Courier New', monospace; font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: rgba(255,255,255,0.28); }

/* ── DONE ── */
.done-inner { display: flex; flex-direction: column; align-items: center; text-align: center; padding: 48px 32px; }
.done-icon { font-size: 72px; margin-bottom: 20px; animation: popIn 0.6s cubic-bezier(0.34,1.56,0.64,1); }
@keyframes popIn { 0% { transform: scale(0); } 70% { transform: scale(1.22); } 100% { transform: scale(1); } }
.done-title { font-family: Georgia, serif; font-size: 42px; font-weight: bold; color: #d4a843; margin-bottom: 8px; }
.done-sub { color: rgba(240,232,213,0.42); font-size: 15px; margin-bottom: 36px; line-height: 1.8; }
.btn-again {
  display: block; margin: 0 auto 14px;
  background: linear-gradient(135deg, #d4a843, #e8c870);
  color: #1c1510; font-weight: bold; font-family: Georgia, serif;
  padding: 15px 44px; border-radius: 99px; font-size: 16px;
  border: none; cursor: pointer; box-shadow: 0 10px 30px rgba(212,168,67,0.38);
  transition: all 0.2s;
}
.btn-again:hover { transform: translateY(-3px) scale(1.03); box-shadow: 0 18px 40px rgba(212,168,67,0.48); }
.btn-back {
  display: block; margin: 0 auto;
  font-family: 'Courier New', monospace; font-size: 11px;
  letter-spacing: 1.5px; text-transform: uppercase;
  color: rgba(255,255,255,0.24); cursor: pointer;
  background: none; border: none; padding: 8px 14px; transition: color 0.2s;
}
.btn-back:hover { color: rgba(255,255,255,0.55); }

/* ── PICKER ── */
.picker-inner { display: flex; flex-direction: column; align-items: center; gap: 14px; padding: 8px 0 60px; width: 100%; }
.pick-title { font-family: Georgia, serif; font-size: 28px; font-style: italic; color: rgba(240,232,213,0.32); margin-bottom: 6px; }
.pick-sub { font-family: 'Courier New', monospace; font-size: 10px; letter-spacing: 2px; text-transform: uppercase; color: rgba(255,255,255,0.16); margin-bottom: 10px; }

.lcard {
  width: 100%; border-radius: 20px; padding: 24px 26px;
  cursor: pointer; display: flex; align-items: center; gap: 18px;
  transition: transform 0.25s, box-shadow 0.25s, border-color 0.25s;
  background: rgba(255,255,255,0.045);
}
.lcard:hover { transform: translateY(-5px); }
.lcard.la { border: 1.5px solid rgba(100,180,245,0.22); }
.lcard.lb { border: 1.5px solid rgba(212,168,67,0.22); }
.lcard.lc { border: 1.5px solid rgba(210,100,100,0.22); }
.lcard.la:hover { box-shadow: 0 24px 56px rgba(100,180,245,0.16); border-color: rgba(100,180,245,0.5); }
.lcard.lb:hover { box-shadow: 0 24px 56px rgba(212,168,67,0.16);  border-color: rgba(212,168,67,0.5); }
.lcard.lc:hover { box-shadow: 0 24px 56px rgba(210,100,100,0.16); border-color: rgba(210,100,100,0.5); }

.l-icon { font-size: 36px; width: 58px; height: 58px; display: flex; align-items: center; justify-content: center; border-radius: 14px; background: rgba(255,255,255,0.06); flex-shrink: 0; }
.l-body { flex: 1; }
.l-tag { font-family: 'Courier New', monospace; font-size: 10px; letter-spacing: 2px; text-transform: uppercase; display: block; margin-bottom: 5px; }
.la .l-tag { color: #6ab4f5; } .lb .l-tag { color: #d4a843; } .lc .l-tag { color: #e07878; }
.l-title { font-family: Georgia, serif; font-size: 22px; font-weight: bold; color: #f0e8d5; margin-bottom: 5px; }
.l-desc { font-size: 13px; color: rgba(240,232,213,0.38); line-height: 1.55; margin-bottom: 6px; }
.l-sample { font-family: Georgia, serif; font-style: italic; font-size: 13px; color: rgba(240,232,213,0.2); }
.l-arr { font-size: 22px; color: rgba(255,255,255,0.17); flex-shrink: 0; transition: transform 0.2s, color 0.2s; }
.lcard:hover .l-arr { transform: translateX(5px); color: rgba(255,255,255,0.45); }

@keyframes cardIn { from { opacity: 0; transform: translateY(18px) scale(0.96); } to { opacity: 1; transform: none; } }

/* ═══════════════════════════════════
   CONVERSATION MODE
═══════════════════════════════════ */

/* Topic picker */
.topic-screen { display:flex; flex-direction:column; align-items:center; gap:14px; padding:8px 0 60px; width:100%; }
.topic-title  { font-family:Georgia,serif; font-size:28px; font-style:italic; color:rgba(240,232,213,0.32); margin-bottom:4px; }
.topic-sub    { font-family:'Courier New',monospace; font-size:10px; letter-spacing:2px; text-transform:uppercase; color:rgba(255,255,255,0.16); margin-bottom:10px; }

.topic-grid   { display:grid; grid-template-columns:1fr 1fr; gap:12px; width:100%; }
.tcard {
  border-radius:18px; padding:20px 18px; cursor:pointer;
  background:rgba(255,255,255,0.045);
  border:1.5px solid rgba(255,255,255,0.08);
  display:flex; flex-direction:column; align-items:center; gap:8px; text-align:center;
  transition:transform 0.2s, box-shadow 0.2s, border-color 0.2s;
}
.tcard:hover { transform:translateY(-4px); border-color:rgba(255,255,255,0.2); box-shadow:0 16px 40px rgba(0,0,0,0.3); }
.tcard .t-ico  { font-size:32px; line-height:1; }
.tcard .t-name { font-family:Georgia,serif; font-size:16px; font-weight:bold; color:#f0e8d5; }
.tcard .t-desc { font-size:12px; color:rgba(240,232,213,0.35); line-height:1.45; }

/* Conversation screen */
.conv-screen { display:flex; flex-direction:column; align-items:center; width:100%; padding-bottom:60px; }

.conv-header {
  width:100%; display:flex; justify-content:space-between; align-items:center;
  margin-bottom:20px;
}
.conv-topic-badge {
  font-family:'Courier New',monospace; font-size:10px; letter-spacing:2px; text-transform:uppercase;
  padding:5px 14px; border-radius:99px;
  background:rgba(212,168,67,0.14); color:#d4a843; border:1px solid rgba(212,168,67,0.3);
}
.conv-back-btn {
  font-family:'Courier New',monospace; font-size:10px; letter-spacing:1.5px; text-transform:uppercase;
  color:rgba(255,255,255,0.28); background:none; border:none; cursor:pointer; padding:5px 10px; transition:color 0.2s;
}
.conv-back-btn:hover { color:rgba(255,255,255,0.6); }

/* Chat bubble area */
.chat-area {
  width:100%; min-height:280px; max-height:360px; overflow-y:auto;
  display:flex; flex-direction:column; gap:12px;
  padding:20px; margin-bottom:20px;
  background:rgba(0,0,0,0.2); border-radius:20px;
  border:1px solid rgba(255,255,255,0.06);
  scroll-behavior:smooth;
}

.bubble {
  max-width:82%; padding:12px 16px; border-radius:18px;
  line-height:1.55; font-size:15px; animation:bubbleIn 0.3s ease both;
}
@keyframes bubbleIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:none} }

.bubble.tutor {
  background:rgba(212,168,67,0.12); border:1px solid rgba(212,168,67,0.2);
  color:#f0e8d5; border-radius:18px 18px 18px 4px;
  align-self:flex-start;
}
.bubble.tutor .bub-label {
  font-family:'Courier New',monospace; font-size:9px; letter-spacing:1.5px; text-transform:uppercase;
  color:rgba(212,168,67,0.6); margin-bottom:5px; display:block;
}
.bubble.student {
  background:rgba(77,184,160,0.12); border:1px solid rgba(77,184,160,0.2);
  color:#f0e8d5; border-radius:18px 18px 4px 18px;
  align-self:flex-end;
}
.bubble.student .bub-label {
  font-family:'Courier New',monospace; font-size:9px; letter-spacing:1.5px; text-transform:uppercase;
  color:rgba(77,184,160,0.6); margin-bottom:5px; display:block; text-align:right;
}
.bubble.correct {
  background:rgba(77,184,160,0.2); border-color:rgba(77,184,160,0.45);
}
.bubble.wrong {
  background:rgba(210,90,90,0.12); border-color:rgba(210,90,90,0.3);
  color:#f0e8d5;
}

/* Sentence to repeat */
.repeat-card {
  width:100%; background:linear-gradient(148deg,#f9f3e5 0%,#ede4cf 100%);
  border-radius:18px; padding:22px 28px; text-align:center;
  box-shadow:0 20px 50px rgba(0,0,0,0.5);
  margin-bottom:20px; position:relative; overflow:hidden;
}
.repeat-card::before {
  content:''; position:absolute; inset:0; border-radius:18px; pointer-events:none;
  background-image:repeating-linear-gradient(0deg,transparent 0px,transparent 30px,rgba(26,20,8,0.05) 30px,rgba(26,20,8,0.05) 31px);
}
.repeat-label {
  font-family:'Courier New',monospace; font-size:9px; letter-spacing:2px; text-transform:uppercase;
  color:rgba(26,20,8,0.35); margin-bottom:10px; display:block; position:relative; z-index:1;
}
.repeat-sentence {
  font-family:Georgia,serif; font-size:22px; font-weight:bold; color:#1c1510;
  line-height:1.45; position:relative; z-index:1;
}
.repeat-sr {
  font-family:Georgia,serif; font-style:italic; font-size:14px;
  color:rgba(26,20,8,0.42); margin-top:8px; position:relative; z-index:1;
}

/* Mic button */
.mic-area { display:flex; flex-direction:column; align-items:center; gap:12px; margin-bottom:20px; }

.mic-btn {
  width:80px; height:80px; border-radius:50%; border:none; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  background:linear-gradient(135deg,rgba(212,168,67,0.2),rgba(212,168,67,0.1));
  border:2px solid rgba(212,168,67,0.35);
  color:#d4a843; font-size:32px;
  transition:all 0.2s; position:relative;
}
.mic-btn:hover { transform:scale(1.08); background:linear-gradient(135deg,rgba(212,168,67,0.3),rgba(212,168,67,0.15)); }
.mic-btn.listening {
  background:linear-gradient(135deg,rgba(210,90,90,0.25),rgba(210,90,90,0.15));
  border-color:rgba(210,90,90,0.6); color:#e09090;
  animation:micPulse 1s ease infinite;
}
.mic-btn.listening::after {
  content:''; position:absolute; inset:-8px; border-radius:50%;
  border:2px solid rgba(210,90,90,0.3); animation:ripple 1s ease infinite;
}
@keyframes micPulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.06)} }
@keyframes ripple   { 0%{transform:scale(1);opacity:0.6} 100%{transform:scale(1.4);opacity:0} }

.mic-status {
  font-family:'Courier New',monospace; font-size:10px; letter-spacing:1.5px; text-transform:uppercase;
  color:rgba(255,255,255,0.3); text-align:center; min-height:18px;
}
.mic-status.active { color:#e09090; animation:blink 1s ease infinite; }
.mic-status.error { color:#e07878; font-weight:bold; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.4} }

.transcript-preview {
  font-family:Georgia,serif; font-size:14px; font-style:italic;
  color:rgba(77,184,160,0.7); min-height:22px; text-align:center;
  padding:0 20px;
}

/* Progress dots */
.conv-progress { display:flex; gap:8px; align-items:center; margin-top:4px; }
.prog-dot { width:8px; height:8px; border-radius:50%; background:rgba(255,255,255,0.15); transition:all 0.3s; }
.prog-dot.done { background:#7ecfbb; box-shadow:0 0 8px rgba(77,184,160,0.5); }
.prog-dot.current { background:#d4a843; box-shadow:0 0 8px rgba(212,168,67,0.5); transform:scale(1.3); }

/* Play tutor btn */
.play-again-btn {
  display:inline-flex; align-items:center; gap:6px;
  font-family:'Courier New',monospace; font-size:10px; letter-spacing:1px; text-transform:uppercase;
  padding:7px 16px; border-radius:99px;
  border:1.5px solid rgba(212,168,67,0.25); background:rgba(212,168,67,0.08);
  color:rgba(212,168,67,0.7); cursor:pointer; transition:all 0.2s;
}
.play-again-btn:hover { background:rgba(212,168,67,0.16); color:#d4a843; transform:translateY(-1px); }
.play-again-btn svg { width:11px; height:11px; fill:currentColor; }

/* Mode selector buttons on home */
.name-screen {
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  min-height:80vh; padding:2rem; text-align:center; gap:20px;
}
.name-title {
  font-family:Georgia,serif; font-size:2.4rem; font-weight:bold;
  color:#f0e8d5; line-height:1.3; margin-bottom:4px;
}
.name-title em { font-style:italic; color:#d4a843; }
.name-sub {
  font-family:'Courier New',monospace; font-size:11px; letter-spacing:2px;
  text-transform:uppercase; color:rgba(255,255,255,0.25); margin-bottom:16px;
}
.name-input-wrap {
  position:relative; width:100%; max-width:340px;
}
.name-input {
  width:100%; padding:16px 20px; border-radius:999px;
  background:rgba(255,255,255,0.07);
  border:1.5px solid rgba(255,255,255,0.15);
  color:#f0e8d5; font-family:Georgia,serif; font-size:18px;
  text-align:center; outline:none;
  transition:border-color 0.2s, background 0.2s;
  caret-color:#d4a843;
}
.name-input::placeholder { color:rgba(255,255,255,0.2); }
.name-input:focus {
  border-color:rgba(212,168,67,0.5);
  background:rgba(255,255,255,0.1);
  box-shadow:0 0 0 4px rgba(212,168,67,0.1);
}
.name-btn {
  padding:14px 44px; border-radius:999px;
  background:linear-gradient(135deg,#d4a843,#e8c870);
  color:#1c1510; font-weight:bold; font-family:Georgia,serif;
  font-size:16px; border:none; cursor:pointer;
  box-shadow:0 10px 28px rgba(212,168,67,0.35);
  transition:all 0.2s; opacity:0.4; pointer-events:none;
}
.name-btn.ready { opacity:1; pointer-events:auto; }
.name-btn.ready:hover { transform:translateY(-3px) scale(1.03); box-shadow:0 16px 38px rgba(212,168,67,0.45); }
.name-greeting {
  font-family:Georgia,serif; font-size:15px; font-style:italic;
  color:rgba(240,232,213,0.45); display:flex; align-items:center; gap:8px;
}
.name-tag {
  display:inline-flex; align-items:center; gap:6px;
  font-family:'Courier New',monospace; font-size:10px; letter-spacing:1.5px;
  text-transform:uppercase; color:rgba(255,255,255,0.4);
  background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.1);
  border-radius:999px; padding:4px 12px; cursor:pointer;
  transition:all 0.2s; margin-left:4px;
}
.name-tag:hover { color:rgba(255,255,255,0.7); border-color:rgba(255,255,255,0.22); }
.mode-row { display:grid; grid-template-columns:1fr 1fr; gap:10px; width:100%; margin-bottom:6px; }
.mode-card {
  flex:1; border-radius:16px; padding:16px 14px;
  cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:6px; text-align:center;
  background:rgba(255,255,255,0.045); border:1.5px solid rgba(255,255,255,0.08);
  transition:all 0.2s;
}
.mode-card:hover { transform:translateY(-3px); border-color:rgba(255,255,255,0.18); }
.mode-card.mc-flash { border-color:rgba(212,168,67,0.25); }
.mode-card.mc-conv  { border-color:rgba(77,184,160,0.25); }
.mode-card.mc-gram  { border-color:rgba(160,120,220,0.25); }
.mode-card.mc-flash:hover { box-shadow:0 12px 32px rgba(212,168,67,0.12); border-color:rgba(212,168,67,0.5); }
.mode-card.mc-conv:hover  { box-shadow:0 12px 32px rgba(77,184,160,0.12);  border-color:rgba(77,184,160,0.5); }
.mode-card.mc-gram:hover  { box-shadow:0 12px 32px rgba(160,120,220,0.12); border-color:rgba(160,120,220,0.5); }
.mode-card .m-ico  { font-size:28px; line-height:1; }
.mode-card .m-name { font-family:Georgia,serif; font-size:15px; font-weight:bold; color:#f0e8d5; }
.mode-card .m-desc { font-size:11px; color:rgba(240,232,213,0.35); line-height:1.4; }
.mode-card .m-tag  { font-family:'Courier New',monospace; font-size:9px; letter-spacing:1.5px; text-transform:uppercase; }
.mc-flash .m-tag { color:rgba(212,168,67,0.6); }
.mc-conv  .m-tag  { color:rgba(77,184,160,0.6); }
.mc-gram  .m-tag  { color:rgba(160,120,220,0.6); }


/* ── GRAMMAR SCREEN ── */
.gram-screen { width:100%; display:flex; flex-direction:column; align-items:center; gap:0; padding-bottom:60px; }
.gram-header { width:100%; display:flex; align-items:center; justify-content:space-between; padding:20px 0 16px; }
.gram-title { font-family:Georgia,serif; font-size:1.7rem; font-style:italic; color:rgba(240,232,213,0.85); }
.gram-back { font-family:'Courier New',monospace; font-size:11px; letter-spacing:1.5px; text-transform:uppercase; color:rgba(255,255,255,0.35); background:rgba(255,255,255,0.07); border:1.5px solid rgba(255,255,255,0.1); border-radius:999px; cursor:pointer; padding:7px 16px; transition:all 0.2s; }
.gram-back:hover { color:#f0e8d5; background:rgba(255,255,255,0.12); }
.gram-intro { font-size:13px; color:rgba(255,255,255,0.3); text-align:center; margin-bottom:20px; font-family:'Courier New',monospace; letter-spacing:0.5px; line-height:1.6; }

.gram-section { width:100%; border-radius:16px; margin-bottom:10px; overflow:hidden; border:1.5px solid rgba(255,255,255,0.07); background:rgba(255,255,255,0.03); transition:border-color 0.2s; }
.gram-section.open { border-color:rgba(160,120,220,0.25); }
.gram-sec-header {
  display:flex; align-items:center; gap:14px;
  padding:16px 20px; cursor:pointer; transition:background 0.2s;
  user-select:none;
}
.gram-sec-header:hover { background:rgba(255,255,255,0.04); }
.gram-sec-icon { font-size:22px; flex-shrink:0; width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:10px; background:rgba(255,255,255,0.05); }
.gram-sec-info { flex:1; }
.gram-sec-num { font-family:'Courier New',monospace; font-size:9px; letter-spacing:2px; text-transform:uppercase; color:rgba(255,255,255,0.25); display:block; margin-bottom:3px; }
.gram-sec-name { font-family:Georgia,serif; font-size:16px; font-weight:bold; color:#f0e8d5; }
.gram-sec-desc { font-size:11px; color:rgba(255,255,255,0.3); margin-top:2px; }
.gram-sec-arrow { font-size:18px; color:rgba(255,255,255,0.2); transition:transform 0.3s, color 0.2s; flex-shrink:0; }
.gram-section.open .gram-sec-arrow { transform:rotate(90deg); color:rgba(160,120,220,0.7); }

.gram-sec-body { display:none; padding:0 20px 18px; }
.gram-section.open .gram-sec-body { display:block; }

.gram-rule {
  background:rgba(255,255,255,0.04); border-radius:12px;
  padding:14px 16px; margin-bottom:10px;
  border-left:3px solid rgba(160,120,220,0.35);
}
.gram-rule:last-child { margin-bottom:0; }
.gram-rule-title { font-family:Georgia,serif; font-size:14px; font-weight:bold; color:rgba(160,120,220,0.9); margin-bottom:6px; }
.gram-rule-body { font-size:13px; color:rgba(255,255,255,0.6); line-height:1.65; }
.gram-rule-body strong { color:#f0e8d5; font-weight:600; }
.gram-rule-body em { font-style:italic; color:rgba(212,168,67,0.85); }
.gram-example {
  margin-top:8px; padding:8px 12px; border-radius:8px;
  background:rgba(255,255,255,0.04);
  font-family:Georgia,serif; font-size:13px;
  color:rgba(240,232,213,0.55); font-style:italic;
  line-height:1.5;
}
.gram-example span { display:block; color:rgba(240,232,213,0.3); font-size:11px; font-style:normal; font-family:'Courier New',monospace; margin-top:2px; }

/* ── GRAMMAR FLASHCARDS ── */
.gf-start-btn {
  display:block; margin:0 auto 20px;
  background:linear-gradient(135deg,rgba(160,120,220,0.25),rgba(160,120,220,0.1));
  border:1.5px solid rgba(160,120,220,0.4); border-radius:999px;
  color:rgba(200,170,255,0.9); font-family:Georgia,serif; font-size:14px;
  padding:10px 28px; cursor:pointer; transition:all 0.2s; width:100%;
}
.gf-start-btn:hover { background:linear-gradient(135deg,rgba(160,120,220,0.38),rgba(160,120,220,0.18)); transform:translateY(-2px); box-shadow:0 8px 24px rgba(160,120,220,0.2); }

.gf-screen { width:100%; display:flex; flex-direction:column; align-items:center; padding-bottom:60px; }

.gf-header { width:100%; display:flex; align-items:center; justify-content:space-between; padding:20px 0 8px; }
.gf-title { font-family:Georgia,serif; font-size:1.1rem; color:rgba(200,170,255,0.8); font-style:italic; }
.gf-back { font-family:'Courier New',monospace; font-size:11px; letter-spacing:1.5px; text-transform:uppercase; color:rgba(255,255,255,0.35); background:rgba(255,255,255,0.07); border:1.5px solid rgba(255,255,255,0.1); border-radius:999px; cursor:pointer; padding:7px 16px; transition:all 0.2s; }
.gf-back:hover { color:#f0e8d5; background:rgba(255,255,255,0.12); }

/* Progress dots */
.gf-prog { display:flex; gap:5px; justify-content:center; margin:8px 0 20px; flex-wrap:wrap; }
.gf-dot { width:7px; height:7px; border-radius:50%; background:rgba(255,255,255,0.1); transition:all 0.3s; }
.gf-dot.rule  { background:rgba(100,160,255,0.5); }
.gf-dot.done  { background:rgba(160,120,220,0.7); box-shadow:0 0 6px rgba(160,120,220,0.5); }
.gf-dot.current { background:#d4a843; box-shadow:0 0 8px rgba(212,168,67,0.6); transform:scale(1.4); }

/* ── RULE CARD (teach) ── */
.gf-rule-card {
  width:100%; border-radius:22px; padding:32px 32px 28px;
  background:linear-gradient(148deg,#141428 0%,#0e0e1e 100%);
  border:1.5px solid rgba(100,140,255,0.2);
  box-shadow:0 30px 60px rgba(0,0,0,0.5), 0 0 0 1px rgba(100,140,255,0.05);
  position:relative; overflow:hidden; margin-bottom:20px;
  animation:cardIn 0.4s cubic-bezier(0.34,1.3,0.64,1) both;
}
.gf-rule-card::before {
  content:''; position:absolute; inset:0; pointer-events:none;
  background:radial-gradient(ellipse 70% 55% at 20% 20%, rgba(100,140,255,0.08) 0%, transparent 65%);
}
.gf-rule-badge {
  display:inline-flex; align-items:center; gap:8px;
  font-family:'Courier New',monospace; font-size:10px; letter-spacing:2px; text-transform:uppercase;
  color:rgba(100,160,255,0.8); background:rgba(100,160,255,0.1);
  border:1px solid rgba(100,160,255,0.2); border-radius:999px;
  padding:4px 14px; margin-bottom:18px;
}
.gf-rule-section { font-family:Georgia,serif; font-size:13px; color:rgba(255,255,255,0.3); margin-bottom:8px; }
.gf-rule-title { font-family:Georgia,serif; font-size:1.5rem; font-weight:bold; color:#f0e8d5; margin-bottom:12px; line-height:1.3; }
.gf-rule-body { font-size:14px; color:rgba(255,255,255,0.65); line-height:1.75; margin-bottom:16px; }
.gf-rule-body strong { color:#f0e8d5; }
.gf-rule-example {
  border-radius:10px; padding:12px 16px;
  background:rgba(255,255,255,0.04); border-left:3px solid rgba(100,160,255,0.3);
  font-family:Georgia,serif; font-style:italic; font-size:13px;
  color:rgba(240,232,213,0.6); line-height:1.6;
}
.gf-rule-example span { display:block; font-style:normal; font-family:'Courier New',monospace; font-size:10px; color:rgba(212,168,67,0.55); margin-top:4px; letter-spacing:0.3px; }
.gf-ready-btn {
  display:block; width:100%; padding:15px; border-radius:14px;
  background:linear-gradient(135deg,rgba(100,140,255,0.22),rgba(100,140,255,0.1));
  border:1.5px solid rgba(100,140,255,0.3); color:rgba(180,200,255,0.9);
  font-family:Georgia,serif; font-size:15px; cursor:pointer; transition:all 0.2s;
  text-align:center; margin-top:4px;
}
.gf-ready-btn:hover { background:rgba(100,140,255,0.3); transform:translateY(-2px); box-shadow:0 8px 24px rgba(100,140,255,0.15); }

/* ── QUESTION CARD (practice) ── */
.gf-q-card {
  width:100%; border-radius:22px; padding:28px 28px 24px;
  background:linear-gradient(148deg,#1c1008 0%,#120c04 100%);
  border:1.5px solid rgba(212,168,67,0.2);
  box-shadow:0 30px 60px rgba(0,0,0,0.5);
  position:relative; overflow:hidden; margin-bottom:16px;
  animation:cardIn 0.4s cubic-bezier(0.34,1.3,0.64,1) both;
}
.gf-q-card::before {
  content:''; position:absolute; inset:0; pointer-events:none;
  background:radial-gradient(ellipse 65% 50% at 80% 20%, rgba(212,168,67,0.07) 0%, transparent 65%);
}
.gf-q-badge {
  display:inline-flex; align-items:center; gap:6px;
  font-family:'Courier New',monospace; font-size:10px; letter-spacing:2px; text-transform:uppercase;
  color:rgba(212,168,67,0.8); background:rgba(212,168,67,0.1);
  border:1px solid rgba(212,168,67,0.2); border-radius:999px;
  padding:4px 14px; margin-bottom:16px;
}
.gf-q-prompt { font-size:12px; color:rgba(255,255,255,0.3); font-family:'Courier New',monospace; letter-spacing:1px; margin-bottom:10px; }
.gf-q-text { font-family:Georgia,serif; font-size:1.3rem; font-weight:bold; color:#f0e8d5; line-height:1.5; margin-bottom:6px; }
.gf-q-hint { font-size:12px; color:rgba(212,168,67,0.5); font-style:italic; margin-bottom:18px; }
.gf-q-sr { font-size:13px; color:rgba(240,232,213,0.3); font-style:italic; margin-bottom:16px; font-family:Georgia,serif; }

/* Type-in input */
.gf-input-wrap { position:relative; width:100%; margin-bottom:12px; }
.gf-input {
  width:100%; padding:14px 20px; border-radius:12px;
  background:rgba(255,255,255,0.07); border:1.5px solid rgba(255,255,255,0.12);
  color:#f0e8d5; font-family:Georgia,serif; font-size:16px;
  outline:none; transition:all 0.2s; caret-color:#d4a843;
}
.gf-input:focus { border-color:rgba(212,168,67,0.4); background:rgba(255,255,255,0.1); box-shadow:0 0 0 3px rgba(212,168,67,0.08); }
.gf-input.correct { border-color:rgba(77,184,160,0.6); background:rgba(77,184,160,0.08); color:#7ecfbb; }
.gf-input.wrong   { border-color:rgba(210,90,90,0.5);  background:rgba(210,90,90,0.06);  }

.gf-submit-btn {
  width:100%; padding:13px; border-radius:12px; border:none; cursor:pointer;
  font-family:Georgia,serif; font-size:15px; font-weight:bold;
  background:linear-gradient(135deg,#d4a843,#e8c870);
  color:#1c1510; transition:all 0.2s; margin-bottom:8px;
}
.gf-submit-btn:hover { transform:translateY(-2px); box-shadow:0 8px 24px rgba(212,168,67,0.3); }
.gf-submit-btn:disabled { opacity:0.35; pointer-events:none; }

.gf-feedback {
  border-radius:12px; padding:12px 16px; font-size:14px; line-height:1.65;
  display:none; animation:fadeUp 0.3s ease; margin-bottom:12px;
}
.gf-feedback.correct { background:rgba(77,184,160,0.1); border:1px solid rgba(77,184,160,0.25); color:#7ecfbb; display:block; }
.gf-feedback.wrong   { background:rgba(210,90,90,0.08); border:1px solid rgba(210,90,90,0.2);  color:#e09090; display:block; }
.gf-feedback.hint    { background:rgba(212,168,67,0.08); border:1px solid rgba(212,168,67,0.2); color:#e8c870; display:block; }

.gf-reveal { font-size:13px; color:rgba(255,255,255,0.25); text-align:center; cursor:pointer; text-decoration:underline; font-family:'Courier New',monospace; letter-spacing:1px; }
.gf-reveal:hover { color:rgba(255,255,255,0.5); }

.gf-next-btn {
  width:100%; padding:13px; border-radius:12px;
  background:rgba(255,255,255,0.07); border:1.5px solid rgba(255,255,255,0.1);
  color:rgba(255,255,255,0.6); font-family:Georgia,serif; font-size:14px;
  cursor:pointer; transition:all 0.2s; display:none;
}
.gf-next-btn:hover { background:rgba(255,255,255,0.12); color:#f0e8d5; }
.gf-next-btn.visible { display:block; }

/* Summary */
.gf-summary { text-align:center; padding:40px 20px; width:100%; }
.gf-sum-icon { font-size:64px; animation:popIn 0.6s cubic-bezier(0.34,1.56,0.64,1); display:block; margin-bottom:16px; }
.gf-sum-title { font-family:Georgia,serif; font-size:2rem; font-weight:bold; color:#d4a843; margin-bottom:8px; }
.gf-sum-sub { color:rgba(255,255,255,0.4); font-size:14px; line-height:1.8; margin-bottom:28px; }
.gf-sum-btn { display:inline-block; padding:13px 36px; border-radius:999px; background:linear-gradient(135deg,#d4a843,#e8c870); color:#1c1510; font-weight:bold; font-family:Georgia,serif; font-size:15px; border:none; cursor:pointer; box-shadow:0 10px 28px rgba(212,168,67,0.35); transition:all 0.2s; margin:4px; }
.gf-sum-btn:hover { transform:translateY(-3px); box-shadow:0 16px 36px rgba(212,168,67,0.45); }
.gf-sum-btn.sec { background:rgba(255,255,255,0.07); border:1.5px solid rgba(255,255,255,0.12); color:rgba(255,255,255,0.55); box-shadow:none; }

@keyframes fadeUp { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:none} }

.mode-card.mc-chal  { border-color:rgba(255,100,130,0.25); }
.mode-card.mc-chal:hover  { box-shadow:0 12px 32px rgba(255,100,130,0.14); border-color:rgba(255,100,130,0.5); }
.mc-chal .m-tag  { color:rgba(255,140,160,0.75); }

/* XP Bar on home screen */
.xp-bar-wrap { width:100%; margin-bottom:6px; }
.xp-bar-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:5px; }
.xp-lbl { font-family:'Courier New',monospace; font-size:10px; letter-spacing:1.5px; text-transform:uppercase; color:rgba(255,255,255,0.28); }
.xp-val { font-family:'Courier New',monospace; font-size:11px; color:#e8c870; font-weight:bold; }
.xp-track { height:4px; background:rgba(255,255,255,0.07); border-radius:99px; }
.xp-fill { height:100%; border-radius:99px; background:linear-gradient(90deg,#ff6482,#e8c870); transition:width 0.8s cubic-bezier(0.34,1.3,0.64,1); }

/* Streak badge */
.streak-badge {
  display:inline-flex; align-items:center; gap:6px;
  font-family:'Courier New',monospace; font-size:10px; letter-spacing:1px;
  color:rgba(255,180,100,0.8); background:rgba(255,140,60,0.1);
  border:1px solid rgba(255,140,60,0.2); border-radius:999px;
  padding:4px 12px; margin-bottom:8px; transition:all 0.3s;
}
.streak-badge.hot { color:#ff9040; border-color:rgba(255,140,60,0.45); background:rgba(255,140,60,0.15); animation:streakPulse 2s ease infinite; }
@keyframes streakPulse { 0%,100%{box-shadow:0 0 0 0 rgba(255,140,60,0.4)} 50%{box-shadow:0 0 0 8px rgba(255,140,60,0)} }

/* Toast notification */
.toast {
  position:fixed; bottom:24px; left:50%; transform:translateX(-50%) translateY(80px);
  background:rgba(20,15,10,0.95); border:1.5px solid rgba(212,168,67,0.3);
  border-radius:14px; padding:12px 22px; font-family:Georgia,serif; font-size:14px;
  color:#f0e8d5; z-index:9999; transition:transform 0.4s cubic-bezier(0.34,1.3,0.64,1), opacity 0.3s;
  opacity:0; pointer-events:none; white-space:nowrap;
  box-shadow:0 20px 40px rgba(0,0,0,0.5);
}
.toast.show { transform:translateX(-50%) translateY(0); opacity:1; }

/* ── CHALLENGE SCREEN ── */
.chal-screen { width:100%; display:flex; flex-direction:column; align-items:center; padding-bottom:80px; }
.chal-header { width:100%; display:flex; align-items:center; justify-content:space-between; padding:20px 0 6px; }
.chal-title { font-family:Georgia,serif; font-size:1.1rem; font-style:italic; color:rgba(255,140,160,0.9); }
.chal-back { font-family:'Courier New',monospace; font-size:11px; letter-spacing:1.5px; text-transform:uppercase; color:rgba(255,255,255,0.35); background:rgba(255,255,255,0.07); border:1.5px solid rgba(255,255,255,0.1); border-radius:999px; cursor:pointer; padding:7px 16px; transition:all 0.2s; }
.chal-back:hover { color:#f0e8d5; background:rgba(255,255,255,0.12); }

/* Challenge cards grid */
.chal-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; width:100%; margin-bottom:20px; }
.chal-card {
  border-radius:18px; padding:20px 16px; cursor:pointer;
  display:flex; flex-direction:column; gap:8px; text-align:center; align-items:center;
  transition:transform 0.25s, box-shadow 0.25s; position:relative; overflow:hidden;
  background:rgba(255,255,255,0.04); border:1.5px solid rgba(255,255,255,0.08);
}
.chal-card:hover { transform:translateY(-5px); }
.chal-card .cc-ico { font-size:2rem; line-height:1; }
.chal-card .cc-name { font-family:Georgia,serif; font-size:15px; font-weight:bold; color:#f0e8d5; }
.chal-card .cc-desc { font-size:11px; color:rgba(255,255,255,0.35); line-height:1.4; }
.chal-card .cc-xp { font-family:'Courier New',monospace; font-size:10px; letter-spacing:1px; color:#e8c870; }
.chal-card.cc-scramble { border-color:rgba(100,200,255,0.25); }
.chal-card.cc-scramble:hover { box-shadow:0 16px 40px rgba(100,200,255,0.15); border-color:rgba(100,200,255,0.5); }
.chal-card.cc-build { border-color:rgba(100,220,160,0.25); }
.chal-card.cc-build:hover { box-shadow:0 16px 40px rgba(100,220,160,0.15); border-color:rgba(100,220,160,0.5); }
.chal-card.cc-odd { border-color:rgba(255,160,80,0.25); }
.chal-card.cc-odd:hover { box-shadow:0 16px 40px rgba(255,160,80,0.15); border-color:rgba(255,160,80,0.5); }
.chal-card.cc-quick { border-color:rgba(255,100,130,0.25); }
.chal-card.cc-quick:hover { box-shadow:0 16px 40px rgba(255,100,130,0.15); border-color:rgba(255,100,130,0.5); }
.chal-card.cc-trans { border-color:rgba(180,120,255,0.25); }
.chal-card.cc-trans:hover { box-shadow:0 16px 40px rgba(180,120,255,0.15); border-color:rgba(180,120,255,0.5); }
.chal-card.cc-spell { border-color:rgba(255,220,80,0.25); }
.chal-card.cc-spell:hover { box-shadow:0 16px 40px rgba(255,220,80,0.15); border-color:rgba(255,220,80,0.5); }

/* ── ACTIVE CHALLENGE ── */
.chal-active { width:100%; }
.chal-type-header {
  display:flex; align-items:center; gap:10px;
  padding:12px 0 16px;
}
.chal-type-ico { font-size:1.8rem; }
.chal-type-name { font-family:Georgia,serif; font-size:1.1rem; font-weight:bold; color:#f0e8d5; }
.chal-round { font-family:'Courier New',monospace; font-size:10px; color:rgba(255,255,255,0.3); letter-spacing:1.5px; }
.chal-timer-bar { height:4px; background:rgba(255,255,255,0.07); border-radius:99px; width:100%; margin-bottom:20px; }
.chal-timer-fill { height:100%; border-radius:99px; background:linear-gradient(90deg,#ff6482,#e8c870); transition:width 0.1s linear; }

/* Question area */
.chal-q-box {
  width:100%; border-radius:20px; padding:26px; margin-bottom:16px;
  background:rgba(255,255,255,0.04); border:1.5px solid rgba(255,255,255,0.08);
  animation:cardIn 0.35s cubic-bezier(0.34,1.3,0.64,1) both;
}
.chal-prompt { font-size:12px; color:rgba(255,255,255,0.3); font-family:'Courier New',monospace; letter-spacing:1.5px; text-transform:uppercase; margin-bottom:10px; }
.chal-question { font-family:Georgia,serif; font-size:1.25rem; font-weight:bold; color:#f0e8d5; line-height:1.5; margin-bottom:6px; }
.chal-sub { font-size:13px; color:rgba(212,168,67,0.6); font-style:italic; margin-bottom:16px; }

/* MCQ options */
.chal-options { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.chal-opt {
  padding:13px 14px; border-radius:13px; cursor:pointer; text-align:center;
  font-family:Georgia,serif; font-size:14px; color:rgba(255,255,255,0.75);
  background:rgba(255,255,255,0.06); border:1.5px solid rgba(255,255,255,0.1);
  transition:all 0.18s; user-select:none;
}
.chal-opt:hover { background:rgba(255,255,255,0.12); border-color:rgba(255,255,255,0.22); transform:translateY(-2px); }
.chal-opt.correct { background:rgba(77,184,160,0.18); border-color:#7ecfbb; color:#7ecfbb; pointer-events:none; }
.chal-opt.wrong   { background:rgba(210,90,90,0.12);  border-color:#e09090; color:#e09090;  pointer-events:none; }
.chal-opt.reveal  { background:rgba(77,184,160,0.08); border-color:rgba(77,184,160,0.3); color:rgba(77,184,160,0.7); pointer-events:none; }
.chal-opt.faded   { opacity:0.3; pointer-events:none; }

/* Word tiles for sentence builder */
.chal-tiles { display:flex; flex-wrap:wrap; gap:8px; min-height:48px; margin-bottom:12px; }
.chal-slot-area { display:flex; flex-wrap:wrap; gap:8px; min-height:52px; padding:10px; border-radius:12px; border:1.5px dashed rgba(255,255,255,0.12); margin-bottom:14px; background:rgba(255,255,255,0.03); }
.tile {
  padding:8px 14px; border-radius:10px; cursor:pointer;
  font-family:Georgia,serif; font-size:14px; color:#f0e8d5;
  background:rgba(100,200,160,0.15); border:1.5px solid rgba(100,200,160,0.3);
  transition:all 0.15s; user-select:none;
}
.tile:hover { background:rgba(100,200,160,0.28); transform:translateY(-2px); }
.tile.placed { background:rgba(212,168,67,0.15); border-color:rgba(212,168,67,0.35); }
.tile.correct-tile { background:rgba(77,184,160,0.2); border-color:#7ecfbb; color:#7ecfbb; cursor:default; }
.tile.wrong-tile   { background:rgba(210,90,90,0.15); border-color:#e09090; cursor:default; }

/* Type input */
.chal-input {
  width:100%; padding:13px 18px; border-radius:12px;
  background:rgba(255,255,255,0.07); border:1.5px solid rgba(255,255,255,0.12);
  color:#f0e8d5; font-family:Georgia,serif; font-size:16px;
  outline:none; transition:all 0.2s; caret-color:#d4a843; margin-bottom:12px;
}
.chal-input:focus { border-color:rgba(212,168,67,0.4); box-shadow:0 0 0 3px rgba(212,168,67,0.08); }
.chal-input.correct { border-color:#7ecfbb; background:rgba(77,184,160,0.08); }
.chal-input.wrong   { border-color:#e09090; background:rgba(210,90,90,0.06); }

/* Check / Next buttons */
.chal-check-btn {
  width:100%; padding:13px; border-radius:12px; border:none; cursor:pointer;
  font-family:Georgia,serif; font-size:15px; font-weight:bold;
  background:linear-gradient(135deg,#ff6482,#e8746a); color:#fff;
  transition:all 0.2s; margin-bottom:8px;
}
.chal-check-btn:hover { transform:translateY(-2px); box-shadow:0 8px 24px rgba(255,100,130,0.35); }
.chal-check-btn:disabled { opacity:0.3; pointer-events:none; }
.chal-next-btn {
  width:100%; padding:13px; border-radius:12px;
  background:rgba(255,255,255,0.07); border:1.5px solid rgba(255,255,255,0.1);
  color:rgba(255,255,255,0.6); font-family:Georgia,serif; font-size:14px;
  cursor:pointer; transition:all 0.2s; display:none;
}
.chal-next-btn.vis { display:block; }
.chal-next-btn:hover { background:rgba(255,255,255,0.13); color:#f0e8d5; }

/* Feedback */
.chal-fb { border-radius:12px; padding:11px 16px; font-size:14px; line-height:1.6; margin-bottom:10px; display:none; }
.chal-fb.correct { background:rgba(77,184,160,0.1); border:1px solid rgba(77,184,160,0.25); color:#7ecfbb; display:block; }
.chal-fb.wrong   { background:rgba(210,90,90,0.08); border:1px solid rgba(210,90,90,0.2);  color:#e09090; display:block; }

/* XP burst animation */
.xp-burst {
  position:fixed; font-family:'Courier New',monospace; font-size:16px; font-weight:bold;
  color:#e8c870; pointer-events:none; z-index:9998;
  animation:xpBurst 1.2s ease forwards;
}
@keyframes xpBurst { 0%{opacity:1;transform:translateY(0) scale(1)} 100%{opacity:0;transform:translateY(-60px) scale(1.4)} }


/* ═══ WORD MAHJONG ═══ */
.cc-mahjong { border-color:rgba(255,200,80,0.3); }
.cc-mahjong:hover { box-shadow:0 16px 40px rgba(255,200,80,0.18); border-color:rgba(255,200,80,0.6); }

.mj-wrap { width:100%; padding-bottom:30px; }

.mj-header {
  display:flex; align-items:center; gap:12px; padding:16px 0 12px;
}
.mj-header-icon { font-size:1.8rem; }
.mj-header-text .mj-h-title { font-family:Georgia,serif; font-size:1.1rem; font-weight:bold; color:#f0e8d5; }
.mj-header-text .mj-h-sub   { font-family:'Courier New',monospace; font-size:10px; color:rgba(255,255,255,0.3); letter-spacing:1.5px; text-transform:uppercase; margin-top:2px; }

.mj-scorebar {
  display:flex; gap:0; border-radius:14px; overflow:hidden;
  border:1px solid rgba(255,255,255,0.07); margin-bottom:16px;
}
.mj-score-item {
  flex:1; padding:10px 0; text-align:center;
  border-right:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.03);
}
.mj-score-item:last-child { border-right:none; }
.mj-score-val { font-family:Georgia,serif; font-size:1.1rem; font-weight:bold; color:#e8c870; }
.mj-score-lbl { font-family:'Courier New',monospace; font-size:9px; letter-spacing:1.5px; text-transform:uppercase; color:rgba(255,255,255,0.25); margin-top:2px; }

/* ── GRID ── */
.mj-grid {
  display:grid;
  grid-template-columns: repeat(4, 1fr);
  gap:10px;
  width:100%;
}

/* ── TILE ── */
.mj-tile {
  aspect-ratio: 0.72;
  border-radius:14px;
  cursor:pointer;
  position:relative;
  overflow:hidden;
  transition:transform 0.18s ease, box-shadow 0.18s ease;
  -webkit-tap-highlight-color:transparent;
}
.mj-tile:active { transform:scale(0.93); }

/* Back face — shown by default */
.mj-tile-back {
  position:absolute; inset:0;
  border-radius:14px;
  background:linear-gradient(160deg,#1e1638 0%,#130f22 100%);
  border:2px solid rgba(140,100,240,0.35);
  box-shadow:0 4px 14px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.07);
  display:flex; align-items:center; justify-content:center;
  transition:opacity 0.22s ease;
  font-size:1.5rem;
}
/* Decorative inner border on back */
.mj-tile-back::before {
  content:'';
  position:absolute; inset:5px;
  border-radius:9px;
  border:1px solid rgba(140,100,240,0.18);
}

/* Front face — hidden by default */
.mj-tile-front {
  position:absolute; inset:0;
  border-radius:14px;
  display:flex; align-items:center; justify-content:center;
  padding:6px;
  font-family:Georgia,serif; font-size:12px; font-weight:bold;
  line-height:1.35; text-align:center;
  opacity:0;
  transition:opacity 0.22s ease;
  word-break:break-word;
  overflow:hidden;
}
.mj-tile-front.lang-en {
  background:linear-gradient(160deg,#0c1e34 0%,#071525 100%);
  border:2px solid rgba(80,160,255,0.5);
  color:rgba(160,210,255,0.95);
  box-shadow:0 4px 14px rgba(0,0,0,0.5), inset 0 1px 0 rgba(80,160,255,0.12);
}
.mj-tile-front.lang-sr {
  background:linear-gradient(160deg,#1e1205 0%,#120b02 100%);
  border:2px solid rgba(212,168,67,0.5);
  color:rgba(240,210,130,0.95);
  box-shadow:0 4px 14px rgba(0,0,0,0.5), inset 0 1px 0 rgba(212,168,67,0.12);
}

/* Flipped — show front, hide back */
.mj-tile.is-flipped .mj-tile-back  { opacity:0; pointer-events:none; }
.mj-tile.is-flipped .mj-tile-front { opacity:1; }
.mj-tile.is-flipped { box-shadow:0 0 0 2px rgba(255,255,255,0.15), 0 8px 24px rgba(0,0,0,0.4); }

/* Matched — dim and lock */
.mj-tile.is-matched .mj-tile-front {
  border-color:rgba(77,184,160,0.6) !important;
  background:linear-gradient(160deg,#082018,#051510) !important;
  color:rgba(100,220,180,0.6) !important;
}
.mj-tile.is-matched { opacity:0.45; pointer-events:none; cursor:default; }
.mj-tile.is-matched:active { transform:none; }

/* Mismatch shake */
@keyframes mj-shake {
  0%,100%{ transform:translateX(0) }
  20%{ transform:translateX(-7px) }
  40%{ transform:translateX(7px) }
  60%{ transform:translateX(-5px) }
  80%{ transform:translateX(5px) }
}
.mj-tile.is-wrong { animation:mj-shake 0.38s ease; border-radius:14px; }
.mj-tile.is-wrong .mj-tile-front { border-color:rgba(220,80,80,0.7) !important; }

/* Match pop */
@keyframes mj-pop {
  0%  { transform:scale(1) }
  40% { transform:scale(1.1) }
  100%{ transform:scale(0.94) }
}
.mj-tile.is-pop { animation:mj-pop 0.4s ease forwards; }

/* ── PROGRESS BAR (below grid) ── */
.mj-progress-wrap { margin-top:14px; }
.mj-progress-top { display:flex; justify-content:space-between; font-family:'Courier New',monospace; font-size:10px; color:rgba(255,255,255,0.3); letter-spacing:1px; margin-bottom:5px; }
.mj-progress-track { height:4px; background:rgba(255,255,255,0.07); border-radius:99px; }
.mj-progress-fill { height:100%; border-radius:99px; background:linear-gradient(90deg,#7ecfbb,#d4a843); transition:width 0.5s cubic-bezier(0.34,1.3,0.64,1); }

/* ── COMPLETE CARD ── */
.mj-complete {
  text-align:center; padding:44px 20px 20px;
  animation:cardIn 0.5s cubic-bezier(0.34,1.3,0.64,1) both;
}
.mj-complete-icon { font-size:56px; display:block; margin-bottom:14px; animation:popIn 0.7s cubic-bezier(0.34,1.56,0.64,1) both; }
.mj-complete-title { font-family:Georgia,serif; font-size:1.9rem; font-weight:bold; color:#d4a843; margin-bottom:6px; }
.mj-complete-sub { font-family:'Courier New',monospace; font-size:10px; color:rgba(255,255,255,0.28); letter-spacing:2px; text-transform:uppercase; margin-bottom:18px; }
.mj-stat-row { display:flex; gap:0; border-radius:14px; overflow:hidden; border:1px solid rgba(255,255,255,0.07); margin-bottom:24px; }
.mj-stat-cell { flex:1; padding:12px 0; text-align:center; border-right:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.03); }
.mj-stat-cell:last-child { border-right:none; }
.mj-stat-cell .sv { font-family:Georgia,serif; font-size:1.2rem; font-weight:bold; color:#f0e8d5; }
.mj-stat-cell .sl { font-family:'Courier New',monospace; font-size:9px; letter-spacing:1.5px; text-transform:uppercase; color:rgba(255,255,255,0.25); margin-top:3px; }
.mj-star { font-size:1.3rem; letter-spacing:4px; margin-bottom:16px; display:block; }

/* ════════════════════════════
   GAMIFICATION SYSTEM
════════════════════════════ */

/* ── Level-up overlay ── */
.levelup-overlay {
  position:fixed; inset:0; z-index:10000;
  display:flex; align-items:center; justify-content:center;
  background:rgba(0,0,0,0.75); backdrop-filter:blur(8px);
  animation:fadeIn 0.3s ease;
}
.levelup-card {
  background:linear-gradient(145deg,#1a1030,#0d0820);
  border:2px solid rgba(212,168,67,0.5);
  border-radius:28px; padding:44px 36px; text-align:center;
  width:320px; box-shadow:0 40px 80px rgba(0,0,0,0.7), 0 0 60px rgba(212,168,67,0.15);
  animation:popIn 0.55s cubic-bezier(0.34,1.56,0.64,1);
}
.levelup-emoji { font-size:56px; display:block; margin-bottom:12px; }
.levelup-tag   { font-family:'Courier New',monospace; font-size:10px; letter-spacing:3px; text-transform:uppercase; color:rgba(212,168,67,0.6); margin-bottom:8px; }
.levelup-num   { font-family:Georgia,serif; font-size:3.5rem; font-weight:bold; color:#e8c870; line-height:1; margin-bottom:4px; }
.levelup-title { font-family:Georgia,serif; font-size:1.2rem; color:#f0e8d5; margin-bottom:10px; }
.levelup-perk  { font-size:13px; color:rgba(255,255,255,0.45); line-height:1.7; margin-bottom:22px; }
.levelup-btn   { padding:12px 36px; border-radius:999px; border:none; cursor:pointer; font-family:Georgia,serif; font-size:15px; font-weight:bold; background:linear-gradient(135deg,#d4a843,#e8c870); color:#1a1010; box-shadow:0 8px 24px rgba(212,168,67,0.4); transition:all 0.2s; }
.levelup-btn:hover { transform:translateY(-2px); box-shadow:0 14px 32px rgba(212,168,67,0.5); }

/* ── Achievement toast ── */
.ach-toast {
  position:fixed; bottom:20px; left:50%; transform:translateX(-50%) translateY(100px);
  background:linear-gradient(135deg,#1a1030,#0d0820);
  border:1.5px solid rgba(212,168,67,0.35);
  border-radius:16px; padding:14px 22px;
  display:flex; align-items:center; gap:14px;
  min-width:280px; max-width:360px;
  box-shadow:0 20px 50px rgba(0,0,0,0.6);
  z-index:9998; opacity:0;
  transition:transform 0.5s cubic-bezier(0.34,1.3,0.64,1), opacity 0.4s ease;
}
.ach-toast.show { transform:translateX(-50%) translateY(0); opacity:1; }
.ach-toast-ico  { font-size:2rem; flex-shrink:0; }
.ach-toast-body .ach-toast-tag  { font-family:'Courier New',monospace; font-size:9px; letter-spacing:2px; text-transform:uppercase; color:rgba(212,168,67,0.6); margin-bottom:2px; }
.ach-toast-body .ach-toast-name { font-family:Georgia,serif; font-size:15px; font-weight:bold; color:#f0e8d5; }
.ach-toast-body .ach-toast-desc { font-size:12px; color:rgba(255,255,255,0.4); margin-top:2px; }

/* ── Lcard completion badge ── */
.lcard-badge {
  position:absolute; top:12px; right:48px;
  font-size:13px; display:none;
  animation:popIn 0.5s cubic-bezier(0.34,1.56,0.64,1);
}
.lcard { position:relative; }

/* ── PROFILE SCREEN ── */
.profile-screen { width:100%; display:flex; flex-direction:column; align-items:center; padding-bottom:60px; }
.profile-header { width:100%; display:flex; align-items:center; justify-content:space-between; padding:20px 0 16px; }
.profile-title  { font-family:Georgia,serif; font-size:1.5rem; font-style:italic; color:rgba(240,232,213,0.85); }

/* Hero card */
.profile-hero {
  width:100%; border-radius:24px; padding:28px 24px;
  background:linear-gradient(145deg,#1a1030,#0d0820);
  border:1.5px solid rgba(212,168,67,0.25);
  margin-bottom:16px; text-align:center;
  box-shadow:0 20px 50px rgba(0,0,0,0.4);
}
.ph-avatar { font-size:52px; margin-bottom:8px; }
.ph-name   { font-family:Georgia,serif; font-size:1.4rem; font-weight:bold; color:#f0e8d5; margin-bottom:4px; }
.ph-level  { font-family:'Courier New',monospace; font-size:11px; letter-spacing:2px; text-transform:uppercase; color:rgba(212,168,67,0.7); margin-bottom:16px; }
.ph-xp-wrap { margin-bottom:8px; }
.ph-xp-top  { display:flex; justify-content:space-between; font-family:'Courier New',monospace; font-size:10px; color:rgba(255,255,255,0.3); margin-bottom:5px; }
.ph-xp-track { height:6px; background:rgba(255,255,255,0.07); border-radius:99px; }
.ph-xp-fill  { height:100%; border-radius:99px; background:linear-gradient(90deg,#ff6482,#d4a843,#7ecfbb); transition:width 0.8s cubic-bezier(0.34,1.3,0.64,1); }
.ph-stats-row { display:flex; gap:0; margin-top:16px; border-top:1px solid rgba(255,255,255,0.07); padding-top:16px; }
.ph-stat { flex:1; text-align:center; border-right:1px solid rgba(255,255,255,0.06); }
.ph-stat:last-child { border-right:none; }
.ph-stat .sv { font-family:Georgia,serif; font-size:1.3rem; font-weight:bold; color:#f0e8d5; }
.ph-stat .sl { font-family:'Courier New',monospace; font-size:9px; letter-spacing:1.5px; text-transform:uppercase; color:rgba(255,255,255,0.25); margin-top:3px; }

/* Section title */
.profile-section { width:100%; margin-bottom:6px; margin-top:10px; }
.profile-section-title { font-family:'Courier New',monospace; font-size:10px; letter-spacing:2px; text-transform:uppercase; color:rgba(255,255,255,0.28); padding:0 2px; }

/* Progress cards (decks / grammar / games) */
.prog-cards { display:flex; flex-direction:column; gap:8px; width:100%; margin-bottom:4px; }
.prog-card {
  width:100%; border-radius:16px; padding:14px 18px;
  display:flex; align-items:center; gap:14px;
  background:rgba(255,255,255,0.04); border:1.5px solid rgba(255,255,255,0.07);
  transition:border-color 0.2s;
}
.prog-card.done { border-color:rgba(77,184,160,0.3); background:rgba(77,184,160,0.06); }
.prog-card-ico  { font-size:1.6rem; flex-shrink:0; width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:10px; background:rgba(255,255,255,0.05); }
.prog-card-body { flex:1; }
.prog-card-name { font-family:Georgia,serif; font-size:14px; font-weight:bold; color:#f0e8d5; margin-bottom:4px; }
.prog-card-bar  { height:4px; background:rgba(255,255,255,0.07); border-radius:99px; margin-bottom:4px; }
.prog-card-fill { height:100%; border-radius:99px; background:linear-gradient(90deg,#6ab4f5,#d4a843); transition:width 0.6s ease; }
.prog-card-meta { font-family:'Courier New',monospace; font-size:10px; color:rgba(255,255,255,0.3); letter-spacing:0.5px; }
.prog-card-check { font-size:1.2rem; flex-shrink:0; }

/* Achievement badges grid */
.ach-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; width:100%; margin-bottom:4px; }
.ach-badge {
  border-radius:16px; padding:16px 10px; text-align:center;
  background:rgba(255,255,255,0.04); border:1.5px solid rgba(255,255,255,0.07);
  transition:all 0.2s;
}
.ach-badge.earned { border-color:rgba(212,168,67,0.3); background:rgba(212,168,67,0.07); }
.ach-badge.locked { opacity:0.35; }
.ach-badge .ab-ico  { font-size:1.8rem; display:block; margin-bottom:6px; filter:grayscale(0); }
.ach-badge.locked .ab-ico { filter:grayscale(1); }
.ach-badge .ab-name { font-family:Georgia,serif; font-size:11px; font-weight:bold; color:#f0e8d5; margin-bottom:3px; }
.ach-badge .ab-desc { font-size:10px; color:rgba(255,255,255,0.3); line-height:1.4; }
.ach-badge.earned .ab-name { color:#e8c870; }
@keyframes fadeIn { from{opacity:0} to{opacity:1} }
</style>
</head>
<body>
<div id="app">
<div class="inner">

  <div class="header">
    <div class="logo">Word<span class="logo-em">Flip</span></div>
    <div style="display:flex;align-items:center;gap:8px;"><div id="nameChangeTag" class="name-tag" onclick="changeName()" style="display:none">✏ You</div><div id="profileBtn" class="name-tag" onclick="showScreen('Profile')" style="display:none;gap:6px;" title="Your profile">🏆 <span id="headerLevel">Lv 1</span></div></div>
    <div class="lv-row" id="lvRow" style="display:none">
      <button class="lv-btn" id="btnA1" onclick="switchLv('a1')">A1–A2</button>
      <button class="lv-btn" id="btnB1" onclick="switchLv('b1')">B1–B2</button>
      <button class="lv-btn" id="btnC1" onclick="switchLv('c1')">C1–C2</button>
    </div>
  </div>

  <!-- PICKER SCREEN -->
  <!-- NAME SCREEN -->
  <div id="screenName" style="display:none;">
    <div class="name-screen">
      <div class="name-title">Welcome to<br><em>WordFlip</em></div>
      <div class="name-sub">Your English learning companion</div>
      <div class="name-input-wrap">
        <input
          class="name-input"
          id="nameInput"
          type="text"
          placeholder="Enter your name…"
          maxlength="30"
          oninput="onNameInput()"
          onkeydown="if(event.key==='Enter') submitName()"
          autocomplete="off"
        />
      </div>
      <button class="name-btn" id="nameSubmitBtn" onclick="submitName()">Let's begin →</button>
    </div>
  </div>

  <div id="screenPicker" style="display:none;">
    <div class="picker-inner">
      <div class="mode-row">
        <div class="mode-card mc-flash" onclick="showScreen('Picker')">
          <span class="m-ico">🃏</span>
          <span class="m-tag">Study Mode</span>
          <span class="m-name">Flashcards</span>
          <span class="m-desc">Flip cards, rate yourself</span>
        </div>
        <div class="mode-card mc-conv" onclick="showScreen('Topic')">
          <span class="m-ico">🎤</span>
          <span class="m-tag">Practice Mode</span>
          <span class="m-name">Conversation</span>
          <span class="m-desc">Speak &amp; repeat with tutor</span>
        </div>
        <div class="mode-card mc-gram" onclick="showScreen('Grammar')">
          <span class="m-ico">📘</span>
          <span class="m-tag">Reference</span>
          <span class="m-name">Grammar</span>
          <span class="m-desc">Rules section by section</span>
        </div>
        <div class="mode-card mc-chal" onclick="showScreen('Challenge')">
          <span class="m-ico">⚡</span>
          <span class="m-tag">Games</span>
          <span class="m-name">Games</span>
          <span class="m-desc">Quick challenges, earn XP</span>
        </div>
      </div>
      <div class="streak-badge" id="streakBadge" style="display:none">🔥 <span id="streakNum">0</span> day streak</div>
      <div class="xp-bar-wrap" id="xpBarWrap" style="display:none">
        <div class="xp-bar-top"><span class="xp-lbl">⚡ XP</span><span class="xp-val" id="xpVal">0 XP</span></div>
        <div class="xp-track"><div class="xp-fill" id="xpFill" style="width:0%"></div></div>
      </div>
      <div class="name-greeting" id="homeGreeting"></div>
      <div class="pick-title">Izaberi nivo</div>
      <div class="pick-sub">Klikni za početak · Choose your level</div>
      <div class="lcard la" onclick="startLv('a1')">
        <div class="l-icon">🌱</div>
        <div class="l-body">
          <span class="l-tag">Razred 2–3 · Početnik</span>
          <div class="l-title">Prve rečenice</div>
          <div class="l-desc">Svakodnevni vokabular, present simple, "can", boje i predlozi.</div>
          <div class="l-sample">"I can swim but I cannot ride a bike."</div>
        </div>
        <div class="l-arr">›</div>
        <div class="lcard-badge" id="badge_a1"></div>
      </div>
      <div class="lcard lb" onclick="startLv('b1')">
        <div class="l-icon">📖</div>
        <div class="l-body">
          <span class="l-tag">Razred 3–4 · Srednji</span>
          <div class="l-title">Više gramatike</div>
          <div class="l-desc">Past simple, present perfect, "going to", poređenje prideva.</div>
          <div class="l-sample">"My best friend is taller than me."</div>
        </div>
        <div class="l-arr">›</div>
        <div class="lcard-badge" id="badge_b1"></div>
      </div>
      <div class="lcard lc" onclick="startLv('c1')">
        <div class="l-icon">🎓</div>
        <div class="l-body">
          <span class="l-tag">Razred 4–5 · Napredni</span>
          <div class="l-title">Napredne strukture</div>
          <div class="l-desc">Conditional I, passive voice, reported speech, relativne rečenice.</div>
          <div class="l-sample">"If it is sunny, we will go to the park."</div>
        </div>
        <div class="l-arr">›</div>
      </div>
    </div>
  </div>

  <!-- CHALLENGE SCREEN -->
  <div id="screenChallenge" style="display:none; width:100%;">
    <div class="chal-screen">
      <div class="chal-header">
        <div class="chal-title" id="chalTitle">⚡ Games</div>
        <button class="chal-back" onclick="exitChallenge()">← Home</button>
      </div>
      <div id="chalArea"></div>
    </div>
  </div>

  <!-- GRAMMAR FLASHCARD SCREEN -->
  <div id="screenGramFlash" style="display:none; width:100%;">
    <div class="gf-screen">
      <div class="gf-header">
        <div class="gf-title" id="gfTitle">📘 Grammar Practice</div>
        <button class="gf-back" onclick="exitGramFlash()">← Back</button>
      </div>
      <div class="gf-prog" id="gfProg"></div>
      <div id="gfCardArea"></div>
    </div>
  </div>

  <!-- GRAMMAR SCREEN -->
  <div id="screenGrammar" style="display:none; width:100%;">
    <div class="gram-screen">
      <div class="gram-header">
        <div class="gram-title">📘 Grammar Rules</div>
        <button class="gram-back" onclick="showScreen('Picker'); updateLvRowVisibility()">← Home</button>
      </div>
      <div class="gram-intro">Tap any section to expand · From the very basics to Present Continuous</div>
      <button class="gf-start-btn" onclick="startGramFlash()">✦ Practice with Flashcards</button>
      <div id="gramSections"></div>
    </div>
  </div>

  <!-- STUDY SCREEN -->
  <div id="screenStudy" style="display:none; width:100%;">
    <div class="prog">
      <div class="prog-top">
        <button onclick="goHome()" style="font-family:'Courier New',monospace;font-size:13px;letter-spacing:1.5px;text-transform:uppercase;color:rgba(255,255,255,0.55);background:rgba(255,255,255,0.07);border:1.5px solid rgba(255,255,255,0.12);border-radius:999px;cursor:pointer;padding:7px 16px;transition:all 0.2s;" onmouseover="this.style.color='#f0e8d5';this.style.background='rgba(255,255,255,0.13)'" onmouseout="this.style.color='rgba(255,255,255,0.55)';this.style.background='rgba(255,255,255,0.07)'">← Home</button>
        <span class="prog-lbl" id="deckLbl">Deck</span>
        <span class="prog-lbl" id="progTxt">0 / 0</span>
      </div>
      <div class="prog-track"><div class="prog-bar" id="progBar" style="width:0%"></div></div>
    </div>

    <div class="scene" id="sceneEl" onclick="handleClick(event)">
      <div class="card" id="cardEl">
        <div class="face front">
          <div class="badge" id="badgeEl">A1</div>
          <div class="sent-en" id="sentEn"></div>
          <div class="tap-hint">👆 tap any word to hear it</div>
          <button class="play-btn" id="playBtn" onclick="event.stopPropagation();playSentence()">
            <svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3A4.5 4.5 0 0 0 14 7.97v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
            Čuj rečenicu [P]
          </button>
          <div class="sr-front">
            <div class="sr-rule"></div>
            <div class="sr-label">Српски превод</div>
            <div class="sr-text" id="srFront">—</div>
          </div>
          <div class="flip-tip">tap to flip ↻</div>
        </div>
        <div class="face back">
          <div class="back-lbl">Превод и граматика</div>
          <div class="sent-sr" id="sentSr">—</div>
          <div class="gram-note" id="gramEl"></div>
        </div>
      </div>
    </div>

    <div class="controls">
      <button class="nav-btn" id="prevBtn" onclick="nav(-1)">←</button>
      <button class="rate-btn r-hard" onclick="rate('hard')">
        <span class="r-ico">😓</span><span class="r-lbl">Тешко</span><span class="r-sub">ПОНОВИ</span>
      </button>
      <button class="rate-btn r-ok" onclick="rate('ok')">
        <span class="r-ico">🤔</span><span class="r-lbl">Ок</span><span class="r-sub">ПРОВЕРИ</span>
      </button>
      <button class="rate-btn r-good" onclick="rate('good')">
        <span class="r-ico">✅</span><span class="r-lbl">Знам</span><span class="r-sub">НАУЧЕНО</span>
      </button>
      <button class="nav-btn" id="nextBtn" onclick="nav(1)">→</button>
    </div>

    <div class="stats">
      <div class="s-box"><span class="s-num" id="nHard">0</span><span class="s-lbl">Тешко</span></div>
      <div class="s-box"><span class="s-num" id="nOk">0</span><span class="s-lbl">Ок</span></div>
      <div class="s-box"><span class="s-num" id="nGood">0</span><span class="s-lbl">Научено</span></div>
    </div>
  </div>

  <!-- DONE SCREEN -->
  <div id="screenDone" style="display:none;">
    <div class="done-inner">
      <div class="done-icon">🎉</div>
      <div class="done-title">Завршено!</div>
      <div class="done-sub" id="doneTxt"></div>
      <button class="btn-again" onclick="restart()">Понови deck</button>
      <button class="btn-back" onclick="goHome()">← Back to home</button>
    </div>
  </div>


  <!-- TOPIC PICKER SCREEN -->
  <div id="screenTopic" style="display:none;">
    <div class="topic-screen">
      <div class="topic-title">Live Conversation</div>
      <div class="topic-sub">Choose a topic to practice</div>
      <div class="topic-grid">
        <div class="tcard" onclick="startConv('basketball')">
          <span class="t-ico">🏀</span>
          <span class="t-name">Basketball</span>
          <span class="t-desc">Players, games, rules</span>
        </div>
        <div class="tcard" onclick="startConv('movies')">
          <span class="t-ico">🎬</span>
          <span class="t-name">Movies</span>
          <span class="t-desc">Films, actors, genres</span>
        </div>
        <div class="tcard" onclick="startConv('sports')">
          <span class="t-ico">⚽</span>
          <span class="t-name">Sports</span>
          <span class="t-desc">Teams, competitions</span>
        </div>
        <div class="tcard" onclick="startConv('geography')">
          <span class="t-ico">🌍</span>
          <span class="t-name">Geography</span>
          <span class="t-desc">Countries, capitals, places</span>
        </div>
        <div class="tcard" style="grid-column:1/-1" onclick="startConv('languages')">
          <span class="t-ico">💬</span>
          <span class="t-name">Languages</span>
          <span class="t-desc">Learning, speaking, cultures</span>
        </div>
      </div>
      <button class="conv-back-btn" style="margin-top:8px" onclick="showScreen('Picker')">← Back to flashcards</button>
    </div>
  </div>

  <!-- CONVERSATION SCREEN -->
  <div id="screenConv" style="display:none;">
    <div class="conv-screen">
      <div class="conv-header">
        <div class="conv-topic-badge" id="convTopicBadge">🏀 Basketball</div>
        <div style="display:flex;align-items:center;gap:10px">
          <div class="conv-progress" id="convProgress"></div>
          <button class="conv-back-btn" onclick="exitConv()">✕ Exit</button>
        </div>
      </div>

      <div class="chat-area" id="chatArea"></div>

      <div class="repeat-card" id="repeatCard" style="display:none">
        <span class="repeat-label">🎤 Repeat this sentence</span>
        <div class="repeat-sentence" id="repeatSentence"></div>
        <div class="repeat-sr" id="repeatSr"></div>
      </div>

      <div class="mic-area">
        <button class="play-again-btn" id="playAgainBtn" onclick="playCurrentSentence()">
          <svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3A4.5 4.5 0 0 0 14 7.97v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
          Hear again
        </button>

        <button class="mic-btn" id="micBtn" onclick="toggleMic()">🎤</button>
        <div class="mic-status" id="micStatus"></div>
        <div class="transcript-preview" id="transcriptPreview"></div>
      </div>

    </div>
  </div>

  <!-- PROFILE / ACHIEVEMENTS SCREEN -->
  <div id="screenProfile" style="display:none; width:100%;">
    <div class="profile-screen">
      <div class="profile-header">
        <div class="profile-title">🏆 Progress &amp; Achievements</div>
        <button class="gram-back" onclick="showScreen('Picker'); updateLvRowVisibility()">← Home</button>
      </div>
      <div id="profileContent"></div>
    </div>
  </div>

</div>
</div>
<div class="toast" id="toast"></div>
<div class="ach-toast" id="achToast"><span class="ach-toast-ico" id="achToastIco">🏅</span><div class="ach-toast-body"><div class="ach-toast-tag">Achievement Unlocked!</div><div class="ach-toast-name" id="achToastName"></div><div class="ach-toast-desc" id="achToastDesc"></div></div></div>

<script>
const DATA = {
  a1:{ lbl:'Razred 2–3 · Početnik', badge:'Razred 2–3', bdg:'ba', cards:[
    {en:'I have a red pencil case.',           sr:'Имам црвену перницу.',                   g:'"Have" — имати; боје испред именице'},
    {en:'The dog is under the chair.',         sr:'Пас је испод столице.',                  g:'"Under" — предлог места; "to be"'},
    {en:'We play in the garden after school.', sr:'Играмо се у башти после школе.',        g:'Present simple; "after" — после'},
    {en:'My mum makes lunch every day.',       sr:'Моја мама прави ручак сваки дан.',      g:'Present simple; "every day"'},
    {en:'There are three cats on the roof.',   sr:'На крову се налазе три мачке.',         g:'"There are" — постоји/постоје'},
    {en:'I can swim but I cannot ride a bike.',sr:'Умем да пливам, али не умем да возим бицикл.', g:'"Can / cannot" — умети/не умети'},
    {en:'She is wearing a yellow dress.',      sr:'Она носи жуту хаљину.',                 g:'Present continuous — "to be + -ing"'},
    {en:'My favourite subject is art.',        sr:'Мој омиљени предмет је ликовно.',       g:'"Favourite" — омиљен; "to be"'},
    {en:'We do not have school on Sunday.',    sr:'Немамо школу у недељу.',                g:'Present simple negative; дан у недељи'},
    {en:'He drinks a glass of milk every morning.', sr:'Он пије чашу млека сваког јутра.', g:'"Every morning" — сваког јутра'},
  ]},
  b1:{ lbl:'Razred 3–4 · Srednji', badge:'Razred 3–4', bdg:'bb', cards:[
    {en:'I was reading a book when it started to rain.',    sr:'Читао/ла сам књигу кад је почела киша.',       g:'Past continuous прекинута прошлом радњом'},
    {en:'She has already finished her homework.',           sr:'Она је већ завршила домаћи задатак.',           g:'Present perfect + "already"'},
    {en:'We went to the zoo last Saturday.',                sr:'Отишли смо у зоо-врт прошле суботе.',          g:'Past simple; "last Saturday"'},
    {en:'There were many animals at the farm.',             sr:'На фарми је било много животиња.',             g:'"There were" — прошлост; множина'},
    {en:'I like drawing, but my brother prefers football.', sr:'Волим цртање, а мој брат воли фудбал.',       g:'"But" — супротни везник; "prefer"'},
    {en:'She is going to visit her grandma tomorrow.',      sr:'Она ће сутра посетити своју баку.',            g:'"Going to" — план у будућности'},
    {en:'Can you please open the window?',                  sr:'Можеш ли молим те да отвориш прозор?',        g:'Учтива молба са "Can you please"'},
    {en:'My best friend is taller than me.',                sr:'Мој најбољи друг је виши од мене.',           g:'Компаратив придева + "than"'},
    {en:'We have been friends since first grade.',          sr:'Пријатељи смо од prvog razreda.',             g:'Present perfect + "since"'},
    {en:'I think science is more interesting than maths.',  sr:'Мислим да је наука занимљивија од математике.', g:'Компаратив; "I think that"'},
  ]},
  c1:{ lbl:'Razred 4–5 · Napredni', badge:'Razred 4–5', bdg:'bc', cards:[
    {en:'If it is sunny tomorrow, we will go to the park.',  sr:'Ако буде сунчано сутра, отићи ћемо у парк.',   g:'Conditional I — реалан услов'},
    {en:'The cake was made by my grandmother.',              sr:'Торту је направила моја бака.',                g:'Passive voice — трпни глагол'},
    {en:'She said that she wanted to become a doctor.',      sr:'Рекла је да жели да постане доктор.',         g:'Reported speech — индиректни говор'},
    {en:'Although it was cold, we played outside.',          sr:'Иако је било хладно, играли смо се напољу.',  g:'"Although" — иако; уступна реченица'},
    {en:'I have never seen such a big spider before.',       sr:'Никад раније нисам видео/ла тако великог паука.', g:'Present perfect + "never" + "before"'},
    {en:'The children who live next door are very friendly.',sr:'Деца која живе поред нас су веома другарска.',  g:'Релативна реченица са "who"'},
    {en:'We must finish the project before Friday.',         sr:'Морамо да завршимо пројекат пре петка.',       g:'"Must" — обавеза; временски рок'},
    {en:'He has been learning English for three years.',     sr:'Он учи енглески већ три године.',             g:'Present perfect continuous — трајање'},
    {en:'My teacher told us to read two books this month.',  sr:'Наш учитељ нам је рекао да прочитамо две књиге овог месеца.', g:'Reported speech са "told us to"'},
    {en:'The museum was closed, so we went to the cinema instead.', sr:'Музеј је био затворен, па смо отишли у биоскоп.', g:'"So" — последица; "instead" — уместо'},
  ]}
};

let lv=null,deck=[],cur=0,flipped=false,ratings=[],stats={hard:0,ok:0,good:0},litEl=null;
let userName = localStorage.getItem('wf_name') || '';

function initApp() {
  if (userName) {
    showScreen('Picker');
    updateNameGreeting();
  } else {
    showScreen('Name');
  }
}

function onNameInput() {
  const val = $('nameInput').value.trim();
  $('nameSubmitBtn').classList.toggle('ready', val.length > 0);
}

function submitName() {
  const val = $('nameInput').value.trim();
  if (!val) return;
  userName = val;
  localStorage.setItem('wf_name', userName);
  updateNameGreeting();
  showScreen('Picker');
}

function changeName() {
  showScreen('Name');
  $('nameInput').value = userName;
  $('nameSubmitBtn').classList.add('ready');
  setTimeout(() => $('nameInput').focus(), 100);
}

function updateNameGreeting() {
  const el = $('homeGreeting');
  if (el) el.innerHTML = 'Welcome back, <strong style="color:#d4a843">' + userName + '</strong>! ' + getTimeGreeting();
  const tag = $('nameChangeTag');
  if (tag) tag.textContent = '✏ ' + userName;
}

function getTimeGreeting() {
  const h = new Date().getHours();
  if (h < 12) return '🌅 Good morning!';
  if (h < 18) return '☀️ Good afternoon!';
  return '🌙 Good evening!';
}
const syn=window.speechSynthesis;
const $=id=>document.getElementById(id);

function showScreen(name){
  ['screenName','screenPicker','screenStudy','screenDone','screenTopic','screenConv','screenGrammar','screenGramFlash','screenChallenge','screenProfile'].forEach(id=>{
    $(id).style.display = id===('screen'+name) ? 'block' : 'none';
  });
  const tag = $('nameChangeTag');
  if (tag) tag.style.display = (name !== 'Name' && userName) ? 'inline-flex' : 'none';
  const pb = $('profileBtn');
  if (pb) pb.style.display = (name !== 'Name' && userName) ? 'inline-flex' : 'none';
  if (name === 'Grammar') buildGrammarScreen();
  if (name === 'Challenge') showChallengeMenu();
  if (name === 'Profile') buildProfileScreen();
  if (name === 'Picker') { updateXPBar(); updateStreakBadge(); updateLevelDisplay(); }
}

function startLv(l){
  lv=l; deck=DATA[l].cards; cur=0; flipped=false;
  ratings=Array(deck.length).fill(null); stats={hard:0,ok:0,good:0};
  ['nHard','nOk','nGood'].forEach(id=>$(id).textContent=0);
  ['a1','b1','c1'].forEach(l2=>{
    $('btn'+l2.toUpperCase()).className='lv-btn'+(l2===l?' '+(l2==='a1'?'a1on':l2==='b1'?'b1on':'c1on'):'');
  });
  $('deckLbl').textContent=DATA[l].lbl;
  $('lvRow').style.display='flex';
  showScreen('Study');
  doCard();
}

function switchLv(l){ if(l!==lv) startLv(l); }

function goHome(){
  syn.cancel();
  $('lvRow').style.display='none';
  showScreen('Picker');
  lv=null;
}

function doCard(){
  const d=deck[cur], ld=DATA[lv];
  const c=$('sentEn'); c.innerHTML='';
  (d.en.match(/[\w'']+|[.,!?;:—]/g)||[]).forEach(tok=>{
    if(/[\w'']/.test(tok)){
      const s=document.createElement('span'); s.className='w'; s.textContent=tok;
      s.addEventListener('click',e=>{e.stopPropagation();sayWord(tok,s);});
      c.appendChild(s);
    } else {
      const last=c.lastChild;
      if(last&&last.className==='w') last.textContent+=tok;
      else c.appendChild(document.createTextNode(tok));
    }
    c.appendChild(document.createTextNode(' '));
  });
  $('srFront').textContent=d.sr; $('sentSr').textContent=d.sr; $('gramEl').textContent=d.g;
  const b=$('badgeEl'); b.textContent=ld.badge; b.className='badge '+ld.bdg;
  syn.cancel(); $('playBtn').className='play-btn'; clearLit();
  $('cardEl').classList.remove('flipped'); flipped=false;
  const sc=$('sceneEl'); sc.style.animation='none'; sc.offsetHeight;
  sc.style.animation='cardIn 0.45s ease both';
  doProg(); doNav();
}

function handleClick(e){
  if(e.target.closest('.play-btn')||e.target.closest('.w'))return;
  flipped=!flipped; $('cardEl').classList.toggle('flipped',flipped);
}

function getVoice(){
  const vs = syn.getVoices();
  // Priority list of known natural-sounding female voices across platforms
  const preferred = [
    'Samantha',        // macOS/iOS — highest quality
    'Karen',           // macOS Australian female
    'Moira',           // macOS Irish female
    'Tessa',           // macOS South African female
    'Fiona',           // macOS Scottish female
    'Allison',         // macOS US female
    'Ava',             // macOS US female (neural)
    'Siri',            // iOS
    'Google US English Female', // Android/Chrome
    'Microsoft Zira',  // Windows US female
    'Microsoft Jenny', // Windows neural female
    'Microsoft Aria',  // Windows neural female
    'Microsoft Emma',  // Windows neural female
  ];
  for (const name of preferred) {
    const v = vs.find(v => v.name.includes(name) && v.lang.startsWith('en'));
    if (v) return v;
  }
  // Fallback: any English female-sounding voice (heuristic by name)
  const femaleHints = ['female','woman','girl','zira','samantha','karen','victoria','allison','ava','jenny','aria','emma','susan','linda','amy'];
  const female = vs.find(v => v.lang.startsWith('en') && femaleHints.some(h => v.name.toLowerCase().includes(h)));
  if (female) return female;
  // Last resort: any English local voice
  return vs.find(v => v.lang === 'en-US' && v.localService)
      || vs.find(v => v.lang.startsWith('en-'))
      || vs.find(v => v.lang.startsWith('en'))
      || null;
}
function say(txt,onS,onE){
  syn.cancel();
  const u=new SpeechSynthesisUtterance(txt);
  u.lang='en-US'; u.rate=0.88; u.pitch=1.05;
  const v=getVoice(); if(v)u.voice=v;
  u.onstart=onS||null; u.onend=u.onerror=onE||null; syn.speak(u);
}
function clearLit(){ if(litEl){litEl.classList.remove('lit');litEl=null;} }
function sayWord(w,el){
  clearLit(); litEl=el; el.classList.add('lit');
  say(w,null,()=>{el.classList.remove('lit');if(litEl===el)litEl=null;});
}
function playSentence(){
  const b=$('playBtn'); clearLit(); b.classList.add('on');
  say(deck[cur].en,null,()=>b.classList.remove('on'));
}

function nav(d){ const n=cur+d; if(n<0||n>=deck.length)return; cur=n; doCard(); }
function rate(r){
  if(ratings[cur]!==null) stats[ratings[cur]]--;
  ratings[cur]=r; stats[r]++;
  $('nHard').textContent=stats.hard; $('nOk').textContent=stats.ok; $('nGood').textContent=stats.good;
  if(cur<deck.length-1){cur++;doCard();}else showDone();
}
function doProg(){
  const n=ratings.filter(x=>x!==null).length;
  $('progBar').style.width=(n/deck.length*100)+'%';
  $('progTxt').textContent=n+' / '+deck.length;
}
function doNav(){
  $('prevBtn').style.opacity=cur===0?'0.3':'1';
  $('nextBtn').style.opacity=cur===deck.length-1?'0.3':'1';
}
function showDone(){
  showScreen('Done');
  $('doneTxt').innerHTML='Прошли сте свих '+deck.length+' реченица.<br>✅ '+stats.good+' научено · 🤔 '+stats.ok+' ок · 😓 '+stats.hard+' за понављање';
}
function restart(){
  cur=0; flipped=false; ratings=Array(deck.length).fill(null); stats={hard:0,ok:0,good:0};
  ['nHard','nOk','nGood'].forEach(id=>$(id).textContent=0);
  showScreen('Study'); doCard();
}

document.addEventListener('keydown',e=>{
  if(!lv)return;
  if(e.key===' '||e.key==='Enter'){e.preventDefault();flipped=!flipped;$('cardEl').classList.toggle('flipped',flipped);}
  if(e.key==='ArrowLeft')nav(-1); if(e.key==='ArrowRight')nav(1);
  if(e.key==='1')rate('hard'); if(e.key==='2')rate('ok'); if(e.key==='3')rate('good');
  if(e.key==='p'||e.key==='P')playSentence();
});

/* ════════════════════════════
   GRAMMAR RULES DATA & UI
════════════════════════════ */
const GRAMMAR = [
  {
    icon: '🔤', name: 'Nouns & Articles',
    desc: 'Names of people, places, things — with "a", "an", "the"',
    rules: [
      {
        title: 'What is a Noun?',
        body: 'A <strong>noun</strong> is a word that names a person, place, animal, or thing.',
        examples: [
          { en: 'a dog, a school, a teacher, a book', sr: 'пас, школа, учитељ, књига' }
        ]
      },
      {
        title: 'Indefinite Article: a / an',
        body: 'Use <strong>a</strong> before consonant sounds, <strong>an</strong> before vowel sounds (a, e, i, o, u). Use it when talking about something for the first time or any one of its kind.',
        examples: [
          { en: 'I have a cat.  ·  She ate an apple.', sr: 'Имам мачку. · Она је јела јабуку.' }
        ]
      },
      {
        title: 'Definite Article: the',
        body: 'Use <strong>the</strong> when both speaker and listener know exactly which thing is meant.',
        examples: [
          { en: 'The cat is on the chair.', sr: 'Мачка је на столици.' }
        ]
      },
      {
        title: 'Plural Nouns',
        body: 'Add <strong>-s</strong> for most nouns. Add <strong>-es</strong> after -s, -sh, -ch, -x. Some nouns are irregular.',
        examples: [
          { en: 'book → books  ·  box → boxes  ·  child → children', sr: 'књига → књиге · кутија → кутије · дете → деца' }
        ]
      }
    ]
  },
  {
    icon: '🙋', name: 'Personal Pronouns',
    desc: 'I, you, he, she, it, we, they — subject and object forms',
    rules: [
      {
        title: 'Subject Pronouns',
        body: 'Use subject pronouns as the <strong>subject</strong> of a verb: <strong>I, you, he, she, it, we, they</strong>.',
        examples: [
          { en: 'I am happy.  ·  She plays tennis.  ·  They live here.', sr: 'Ја сам срећан. · Она игра тенис. · Они живе овде.' }
        ]
      },
      {
        title: 'Object Pronouns',
        body: 'Use object pronouns as the <strong>object</strong> of a verb: <strong>me, you, him, her, it, us, them</strong>.',
        examples: [
          { en: 'She likes him.  ·  Can you help me?', sr: 'Она га воли. · Можеш ли да ми помогнеш?' }
        ]
      },
      {
        title: 'Possessive Adjectives',
        body: 'Show belonging: <strong>my, your, his, her, its, our, their</strong>.',
        examples: [
          { en: 'This is my bag.  ·  Her cat is white.', sr: 'Ово је моја торба. · Њена мачка је бела.' }
        ]
      }
    ]
  },
  {
    icon: '🔵', name: 'To Be — Present Simple',
    desc: '"am, is, are" — describing people and things',
    rules: [
      {
        title: 'Positive Forms',
        body: '<strong>I am</strong> · <strong>you are</strong> · <strong>he/she/it is</strong> · <strong>we/they are</strong>. Short forms: I\'m, you\'re, he\'s, she\'s, it\'s, we\'re, they\'re.',
        examples: [
          { en: 'I am seven years old.  ·  She is my teacher.', sr: 'Имам седам година. · Она је моја учитељица.' }
        ]
      },
      {
        title: 'Negative Forms',
        body: 'Add <strong>not</strong> after the verb: am not, is not (isn\'t), are not (aren\'t).',
        examples: [
          { en: 'He is not tall.  ·  We are not late.', sr: 'Он није висок. · Нисмо закаснили.' }
        ]
      },
      {
        title: 'Questions',
        body: 'Move the verb before the subject: <strong>Am I? / Is he? / Are they?</strong>',
        examples: [
          { en: 'Is she your sister?  ·  Are you ready?', sr: 'Је ли она твоја сестра? · Јеси ли спреман?' }
        ]
      }
    ]
  },
  {
    icon: '✅', name: 'Present Simple',
    desc: 'Habits, facts, routines — what you do every day',
    rules: [
      {
        title: 'Positive Form',
        body: 'Use the base verb for I/you/we/they. Add <strong>-s</strong> or <strong>-es</strong> for he/she/it.',
        examples: [
          { en: 'I play football.  ·  She plays football.', sr: 'Ја играм фудбал. · Она игра фудбал.' }
        ]
      },
      {
        title: 'Negative Form',
        body: 'Use <strong>do not (don\'t)</strong> or <strong>does not (doesn\'t)</strong> + base verb.',
        examples: [
          { en: 'I don\'t like fish.  ·  He doesn\'t watch TV.', sr: 'Не волим рибу. · Он не гледа ТВ.' }
        ]
      },
      {
        title: 'Questions',
        body: 'Use <strong>Do</strong> or <strong>Does</strong> at the start: Do you…? Does she…?',
        examples: [
          { en: 'Do you have a pet?  ·  Does he go to school?', sr: 'Имаш ли кућног љубимца? · Иде ли он у школу?' }
        ]
      },
      {
        title: 'Time Expressions',
        body: 'Common words used with present simple: <strong>every day, always, usually, sometimes, never, on Mondays</strong>.',
        examples: [
          { en: 'I always brush my teeth.  ·  We never eat sweets.', sr: 'Увек перем зубе. · Никад не јемо слаткише.' }
        ]
      }
    ]
  },
  {
    icon: '🏷', name: 'Adjectives',
    desc: 'Words that describe nouns — colour, size, feeling',
    rules: [
      {
        title: 'Position of Adjectives',
        body: 'Adjectives usually come <strong>before the noun</strong> or after the verb "to be".',
        examples: [
          { en: 'a big dog  ·  The sky is blue.', sr: 'велики пас · Небо је плаво.' }
        ]
      },
      {
        title: 'Comparative Form',
        body: 'To compare two things: add <strong>-er</strong> (short adjectives) or use <strong>more</strong> (long adjectives) + than.',
        examples: [
          { en: 'My bag is bigger than yours.  ·  This book is more interesting.', sr: 'Моја торба је већа од твоје. · Ова књига је занимљивија.' }
        ]
      },
      {
        title: 'Superlative Form',
        body: 'For the highest degree: add <strong>-est</strong> or use <strong>the most</strong>.',
        examples: [
          { en: 'She is the tallest in the class.  ·  This is the most beautiful flower.', sr: 'Она је највиша у разреду. · Ово је најлепши цвет.' }
        ]
      }
    ]
  },
  {
    icon: '🚀', name: 'Can / Cannot',
    desc: 'Ability and permission — what you can and cannot do',
    rules: [
      {
        title: 'Positive & Negative',
        body: 'Use <strong>can</strong> + base verb for ability. Use <strong>cannot (can\'t)</strong> for inability. The form is the same for all pronouns — no -s needed.',
        examples: [
          { en: 'I can ride a bike.  ·  She can\'t swim yet.', sr: 'Умем да возим бицикл. · Она још не умее да плива.' }
        ]
      },
      {
        title: 'Questions with Can',
        body: 'Put <strong>Can</strong> at the beginning: <em>Can you…?</em> Answer: <em>Yes, I can. / No, I can\'t.</em>',
        examples: [
          { en: 'Can you speak English?  ·  Yes, I can!', sr: 'Умеш ли да говориш енглески? · Да, умем!' }
        ]
      }
    ]
  },
  {
    icon: '📍', name: 'Prepositions of Place',
    desc: 'Where things are — in, on, under, next to, behind…',
    rules: [
      {
        title: 'Common Prepositions',
        body: '<strong>in</strong> (inside) · <strong>on</strong> (on a surface) · <strong>under</strong> (below) · <strong>next to</strong> (beside) · <strong>behind</strong> (at the back) · <strong>in front of</strong> (before).',
        examples: [
          { en: 'The ball is under the table.  ·  The cat is next to the door.', sr: 'Лопта је испод стола. · Мачка је поред врата.' }
        ]
      },
      {
        title: 'There is / There are',
        body: 'Use <strong>There is</strong> for one thing, <strong>There are</strong> for more than one.',
        examples: [
          { en: 'There is a bird in the tree.  ·  There are three apples.', sr: 'У дрвету је птица. · Има три јабуке.' }
        ]
      }
    ]
  },
  {
    icon: '🕐', name: 'Telling the Time & Dates',
    desc: 'How to say what time and day it is',
    rules: [
      {
        title: 'Telling the Time',
        body: 'Use <strong>It is…</strong> + time. For the hour: <em>It\'s three o\'clock.</em> Half past: <em>It\'s half past four.</em> Quarter past/to: <em>It\'s quarter past six.</em>',
        examples: [
          { en: 'It is half past eight.  ·  What time is it?', sr: 'Пола је девет. · Колико је сати?' }
        ]
      },
      {
        title: 'Days & Preposition "on"',
        body: 'Use <strong>on</strong> with days of the week.',
        examples: [
          { en: 'We have PE on Monday.  ·  I visit grandma on Sunday.', sr: 'Имамо ФВ у понедељак. · Посећујем баку у недељу.' }
        ]
      },
      {
        title: 'Months & Preposition "in"',
        body: 'Use <strong>in</strong> with months and seasons.',
        examples: [
          { en: 'My birthday is in March.  ·  It snows in winter.', sr: 'Рођендан ми је у марту. · Снег пада зими.' }
        ]
      }
    ]
  },
  {
    icon: '🔄', name: 'Present Continuous',
    desc: 'Actions happening right now — I am playing, she is reading',
    rules: [
      {
        title: 'How to Form It',
        body: 'Use <strong>to be (am/is/are)</strong> + verb <strong>+ -ing</strong>.',
        examples: [
          { en: 'I am reading a book.  ·  She is eating lunch.', sr: 'Читам књигу. · Она ручак.' }
        ]
      },
      {
        title: 'Spelling Rules for -ing',
        body: 'Most verbs: just add <strong>-ing</strong>. Verbs ending in -e: drop the -e first. Short verbs (consonant-vowel-consonant): double the last consonant.',
        examples: [
          { en: 'play → playing  ·  write → writing  ·  run → running', sr: 'играти → играм · писати → пишем · трчати → трчим' }
        ]
      },
      {
        title: 'Negative Form',
        body: 'Add <strong>not</strong> after am/is/are: <em>am not, isn\'t, aren\'t</em> + -ing.',
        examples: [
          { en: 'I am not watching TV.  ·  They aren\'t sleeping.', sr: 'Не гледам ТВ. · Они не спавају.' }
        ]
      },
      {
        title: 'Questions',
        body: 'Move am/is/are before the subject.',
        examples: [
          { en: 'Is she dancing?  ·  What are you doing?', sr: 'Да ли она плеше? · Шта радиш?' }
        ]
      },
      {
        title: 'Present Simple vs Continuous',
        body: '<strong>Present simple</strong> = habits/facts. <strong>Present continuous</strong> = happening right now.',
        examples: [
          { en: 'I usually walk to school. (habit)  ·  I am walking now. (now)', sr: 'Обично ходам у школу. · Сада идем пешке.' }
        ]
      }
    ]
  }
];

function buildGrammarScreen() {
  const container = $('gramSections');
  if (!container || container.children.length > 0) return; // already built
  GRAMMAR.forEach((section, si) => {
    const sec = document.createElement('div');
    sec.className = 'gram-section';
    sec.id = 'gsec_' + si;

    sec.innerHTML = `
      <div class="gram-sec-header" onclick="toggleGramSection(${si})">
        <div class="gram-sec-icon">${section.icon}</div>
        <div class="gram-sec-info">
          <span class="gram-sec-num">Section ${si + 1} of ${GRAMMAR.length}</span>
          <div class="gram-sec-name">${section.name}</div>
          <div class="gram-sec-desc">${section.desc}</div>
        </div>
        <div class="gram-sec-arrow">›</div>
      </div>
      <div class="gram-sec-body">
        ${section.rules.map(rule => `
          <div class="gram-rule">
            <div class="gram-rule-title">${rule.title}</div>
            <div class="gram-rule-body">${rule.body}</div>
            ${rule.examples.map(ex => `
              <div class="gram-example">
                ${ex.en}
                <span>${ex.sr}</span>
              </div>
            `).join('')}
          </div>
        `).join('')}
      </div>
    `;
    container.appendChild(sec);
  });
}

function toggleGramSection(idx) {
  const sec = $('gsec_' + idx);
  const isOpen = sec.classList.contains('open');
  // Close all
  document.querySelectorAll('.gram-section').forEach(s => s.classList.remove('open'));
  // Toggle clicked
  if (!isOpen) sec.classList.add('open');
}

function updateLvRowVisibility() {
  $('lvRow').style.display = 'none';
}


/* ════════════════════════════════════════
   GRAMMAR FLASHCARDS (Montessori)
════════════════════════════════════════ */

// Build a flat list of cards from GRAMMAR data:
// Each rule becomes: [rule_card, question_card, question_card, ...]
function buildGFDeck() {
  const cards = [];
  GRAMMAR.forEach((section, si) => {
    section.rules.forEach((rule, ri) => {
      // Rule intro card (teach)
      cards.push({ type:'rule', section, si, rule, ri });
      // One or more question cards per rule example
      if (rule.examples && rule.examples.length) {
        rule.examples.forEach((ex, ei) => {
          // Generate fill-in questions from the example
          const qs = makeQuestions(rule, ex);
          qs.forEach(q => cards.push({ type:'question', section, si, rule, ri, q }));
        });
      }
    });
  });
  return cards;
}

// Turn a rule + example into 1-2 typed questions
function makeQuestions(rule, ex) {
  const questions = [];
  const words = ex.en.split(/\s+/);

  // Strategy: blank out the most grammatically important word(s)
  // We look for key grammar words defined per rule title
  const keyPatterns = [
    { match:/article/i, targets:/(^|\s)(a|an|the)(\s|$)/gi },
    { match:/plural/i,  targets:/(\w+s)(\s|\.|,|$)/g },
    { match:/pronoun/i, targets:/^(I|you|he|she|it|we|they|me|him|her|us|them)\b/i },
    { match:/to be|am.*is.*are/i, targets:/\b(am|is|are|isn't|aren't|am not)\b/gi },
    { match:/present simple/i, targets:/\b(don't|doesn't|do|does)\b/gi },
    { match:/can/i, targets:/\b(can|cannot|can't)\b/gi },
    { match:/preposition/i, targets:/\b(in|on|under|next to|behind|in front of|at)\b/gi },
    { match:/time|date/i, targets:/\b(in|on|at)\b/gi },
    { match:/continuous/i, targets:/\b(am|is|are)\b.*ing|\w+ing\b/gi },
    { match:/comparative/i, targets:/\b(more|than|\w+er)\b/gi },
    { match:/superlative/i, targets:/\b(most|the \w+est)\b/gi },
    { match:/possessive/i, targets:/\b(my|your|his|her|its|our|their)\b/gi },
  ];

  // Find which key to blank
  let blankWord = null;
  let blankIdx = -1;
  for (const pat of keyPatterns) {
    if (pat.match.test(rule.title)) {
      const m = ex.en.match(pat.targets);
      if (m && m.length) { blankWord = m[0].trim(); break; }
    }
  }

  // Fallback: blank the 3rd or 4th word if not too short
  if (!blankWord && words.length >= 4) {
    blankIdx = Math.min(3, words.length - 1);
    blankWord = words[blankIdx].replace(/[.,!?]/, '');
  }

  if (!blankWord) {
    // Last resort: ask them to type the whole short sentence
    questions.push({
      instruction: 'Type the complete sentence:',
      prompt: ex.sr,
      answer: ex.en,
      hint: ex.en.split(' ').slice(0, 2).join(' ') + '…',
      fullSentence: true
    });
    return questions;
  }

  // Build fill-in question: replace blank word with ___
  const clean = blankWord.replace(/[.,!?]/g, '');
  const gapped = ex.en.replace(new RegExp('\\b' + escapeReg(clean) + '\\b', 'i'), '___');

  questions.push({
    instruction: 'Fill in the missing word:',
    prompt: gapped,
    sr: ex.sr,
    answer: clean,
    hint: clean[0] + '_'.repeat(clean.length - 1),
    fullSentence: false
  });

  return questions;
}

function escapeReg(s) { return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

// State
let gfDeck = [];
let gfIdx = 0;
let gfCorrect = 0;
let gfAttempts = {};

function startGramFlash() {
  gfDeck = buildGFDeck();
  gfIdx = 0; gfCorrect = 0; gfAttempts = {};
  showScreen('GramFlash');
  $('lvRow').style.display = 'none';
  renderGFCard();
}

function exitGramFlash() {
  syn.cancel();
  showScreen('Grammar');
  $('lvRow').style.display = 'none';
}

function renderGFProg() {
  const prog = $('gfProg');
  prog.innerHTML = '';
  gfDeck.forEach((card, i) => {
    const d = document.createElement('div');
    let cls = 'gf-dot ';
    if (i < gfIdx) cls += 'done';
    else if (i === gfIdx) cls += 'current';
    else cls += card.type === 'rule' ? 'rule' : '';
    d.className = cls;
    prog.appendChild(d);
  });
}

function renderGFCard() {
  renderGFProg();
  const area = $('gfCardArea');
  area.innerHTML = '';
  if (gfIdx >= gfDeck.length) { renderGFSummary(); return; }

  const card = gfDeck[gfIdx];
  $('gfTitle').textContent = card.section.icon + ' ' + card.section.name;

  if (card.type === 'rule') renderRuleCard(card, area);
  else renderQuestionCard(card, area);
}

function renderRuleCard(card, area) {
  const { section, si, rule } = card;
  const exHtml = rule.examples.map(ex => `
    <div class="gf-rule-example">
      ${ex.en}<span>${ex.sr}</span>
    </div>`).join('');

  const div = document.createElement('div');
  div.innerHTML = `
    <div class="gf-rule-card">
      <div class="gf-rule-badge">📖 Read the rule</div>
      <div class="gf-rule-section">${section.name} · Rule ${card.ri + 1}</div>
      <div class="gf-rule-title">${rule.title}</div>
      <div class="gf-rule-body">${rule.body}</div>
      ${exHtml}
    </div>
    <button class="gf-ready-btn" onclick="gfNext()">I understand — show me a question ›</button>
  `;
  area.appendChild(div);

  // Speak the rule title naturally
  setTimeout(() => speakGF(rule.title), 400);
}

function renderQuestionCard(card, area) {
  const { section, rule, q } = card;
  const attempts = gfAttempts[gfIdx] || 0;

  const div = document.createElement('div');
  div.innerHTML = `
    <div class="gf-q-card">
      <div class="gf-q-badge">✏ Your turn</div>
      <div class="gf-q-prompt">${q.instruction}</div>
      <div class="gf-q-text">${q.prompt}</div>
      ${q.sr ? '<div class="gf-q-sr">' + q.sr + '</div>' : ''}
      <div class="gf-input-wrap">
        <input class="gf-input" id="gfInput" type="text"
          placeholder="Type your answer…"
          autocomplete="off" autocorrect="off" spellcheck="false"
          onkeydown="if(event.key==='Enter') checkGFAnswer()"
          oninput="$('gfSubmit').disabled=!this.value.trim()"
        />
      </div>
      <button class="gf-submit-btn" id="gfSubmit" onclick="checkGFAnswer()" disabled>Check ✓</button>
      <div class="gf-feedback" id="gfFeedback"></div>
      <button class="gf-next-btn" id="gfNext" onclick="gfNext()">Next →</button>
    </div>
    <button class="gf-reveal" onclick="revealGFAnswer()">Show me the answer</button>
  `;
  area.appendChild(div);
  setTimeout(() => { const inp = $('gfInput'); if (inp) inp.focus(); }, 300);

  // Speak the prompt, blanks replaced with "blank"
  const spokenPrompt = q.prompt.replace(/___/g, 'blank');
  setTimeout(() => speakGF(spokenPrompt), 400);
}

function checkGFAnswer() {
  const inp = $('gfInput');
  if (!inp) return;
  const val = inp.value.trim();
  if (!val) return;

  const card = gfDeck[gfIdx];
  const correct = card.q.answer;
  const attempts = (gfAttempts[gfIdx] || 0) + 1;
  gfAttempts[gfIdx] = attempts;

  const fb = $('gfFeedback');
  const nextBtn = $('gfNext');

  // Flexible matching: ignore case, punctuation, allow partial
  const clean = s => s.toLowerCase().replace(/[.,!?'"]/g, '').trim();
  const isCorrect = clean(val) === clean(correct)
    || clean(correct).includes(clean(val))
    || clean(val).includes(clean(correct));

  inp.disabled = true;
  $('gfSubmit').disabled = true;

  if (isCorrect) {
    inp.className = 'gf-input correct';
    gfCorrect++;
    const praise = ['Excellent! 🌟', 'Perfect! ✨', 'Well done! 🎉', 'Exactly right! 💫', 'Brilliant! 👏'][Math.floor(Math.random()*5)];
    fb.className = 'gf-feedback correct';
    fb.innerHTML = praise + '<br><small>Answer: <strong>' + correct + '</strong></small>';
    speakGF(praise);
    nextBtn.textContent = gfIdx < gfDeck.length - 1 ? 'Next →' : 'See results →';
    nextBtn.classList.add('visible');
  } else if (attempts >= 2) {
    inp.className = 'gf-input wrong';
    fb.className = 'gf-feedback hint';
    fb.innerHTML = 'The answer is: <strong>' + correct + '</strong> — keep practising! 💪';
    speakGF('The answer is: ' + correct);
    nextBtn.textContent = gfIdx < gfDeck.length - 1 ? 'Next →' : 'See results →';
    nextBtn.classList.add('visible');
  } else {
    inp.className = 'gf-input wrong';
    const hint = card.q.hint;
    fb.className = 'gf-feedback wrong';
    fb.innerHTML = 'Not quite. Hint: <strong>' + hint + '</strong> — try again!';
    speakGF('Try again. The word starts with ' + correct[0]);
    inp.disabled = false;
    inp.value = '';
    inp.focus();
    $('gfSubmit').disabled = false;
  }
}

function revealGFAnswer() {
  const card = gfDeck[gfIdx];
  const fb = $('gfFeedback');
  const inp = $('gfInput');
  const nextBtn = $('gfNext');
  if (inp) { inp.disabled = true; inp.value = card.q.answer; inp.className = 'gf-input'; }
  $('gfSubmit').disabled = true;
  fb.className = 'gf-feedback hint';
  fb.innerHTML = 'Answer: <strong>' + card.q.answer + '</strong> — read it, remember it, move on!';
  speakGF(card.q.answer);
  nextBtn.textContent = gfIdx < gfDeck.length - 1 ? 'Next →' : 'See results →';
  nextBtn.classList.add('visible');
}

function gfNext() {
  gfIdx++;
  renderGFCard();
  window.scrollTo(0, 0);
}

function renderGFSummary() {
  const area = $('gfCardArea');
  const total = gfDeck.filter(c => c.type === 'question').length;
  const pct = Math.round(gfCorrect / total * 100);
  let icon, msg;
  if (pct >= 80) { icon = '🏆'; msg = 'Outstanding! You really know your grammar.'; }
  else if (pct >= 55) { icon = '⭐'; msg = 'Good work! A little more practice and you\'ll master it.'; }
  else { icon = '📚'; msg = 'Keep going — every attempt makes you stronger!'; }

  area.innerHTML = `
    <div class="gf-summary">
      <span class="gf-sum-icon">${icon}</span>
      <div class="gf-sum-title">${pct}% correct</div>
      <div class="gf-sum-sub">${msg}<br><br>You answered <strong>${gfCorrect}</strong> out of <strong>${total}</strong> questions correctly.</div>
      <button class="gf-sum-btn" onclick="startGramFlash()">Practice again</button>
      <button class="gf-sum-btn sec" onclick="exitGramFlash()">← Back to reference</button>
    </div>`;
  speakGF(msg);
}

function speakGF(text) {
  syn.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'en-US'; u.rate = 0.88; u.pitch = 1.05;
  const v = getVoice(); if (v) u.voice = v;
  syn.speak(u);
}

/* ════════════════════════════════════════
   MICRO CHALLENGES
════════════════════════════════════════ */

let xp       = parseInt(localStorage.getItem('wf_xp') || '0');
let streak   = parseInt(localStorage.getItem('wf_streak') || '0');
let lastPlay = localStorage.getItem('wf_lastplay') || '';

function saveXP() {
  localStorage.setItem('wf_xp', xp);
  localStorage.setItem('wf_streak', streak);
  localStorage.setItem('wf_lastplay', new Date().toDateString());
}

function updateXPBar() {
  const el = $('xpBarWrap');
  if (!el || !userName) return;
  el.style.display = 'block';
  $('xpVal').textContent = xp + ' XP';
  $('xpFill').style.width = Math.min(100, (xp % 200) / 200 * 100) + '%';
}

function updateStreakBadge() {
  const el = $('streakBadge');
  if (!el || !userName) return;
  const today = new Date().toDateString();
  if (lastPlay && lastPlay !== today) {
    const diff = (new Date(today) - new Date(lastPlay)) / 86400000;
    if (diff > 1) { streak = 0; saveXP(); }
  }
  if (streak > 0) {
    el.style.display = 'inline-flex';
    $('streakNum').textContent = streak;
    el.className = 'streak-badge' + (streak >= 3 ? ' hot' : '');
  } else {
    el.style.display = 'none';
  }
}

function awardXP(amount, x, y) {
  xp += amount;
  const today = new Date().toDateString();
  if (lastPlay !== today) { streak++; lastPlay = today; }
  saveXP();
  const burst = document.createElement('div');
  burst.className = 'xp-burst';
  burst.textContent = '+' + amount + ' XP';
  burst.style.cssText = 'left:' + (x || window.innerWidth/2) + 'px;top:' + (y || 200) + 'px;';
  document.body.appendChild(burst);
  setTimeout(function() { burst.remove(); }, 1300);
}

function showToast(msg) {
  const t = $('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(function() { t.classList.remove('show'); }, 2800);
}

function getAllCards() {
  const cards = [];
  Object.values(DATA).forEach(function(lv) { lv.cards.forEach(function(c) { cards.push(c); }); });
  return cards;
}

function getRandCards(n) {
  return getAllCards().sort(function() { return Math.random() - 0.5; }).slice(0, n);
}

const CHALLENGE_TYPES = [
  { id:'scramble', ico:'🔀', name:'Word Scramble',     desc:'Unscramble the jumbled word',     xp:10, cls:'cc-scramble' },
  { id:'build',    ico:'🧩', name:'Sentence Builder',  desc:'Tap words in the right order',    xp:15, cls:'cc-build'    },
  { id:'odd',      ico:'🎯', name:'Odd One Out',        desc:'Find the word that does not fit', xp:10, cls:'cc-odd'      },
  { id:'quick',    ico:'⚡', name:'Quick Fire',         desc:'5 questions, beat the clock',     xp:20, cls:'cc-quick'    },
  { id:'trans',    ico:'🌍', name:'Translation Match', desc:'Match English to Serbian',        xp:12, cls:'cc-trans'    },
  { id:'spell',    ico:'✍',  name:'Spelling Bee',       desc:'Listen and spell the word',       xp:15, cls:'cc-spell'    },
  { id:'mahjong',  ico:'🀄', name:'Word Mahjong',       desc:'Flip tiles, match pairs to clear',  xp:25, cls:'cc-mahjong'  },
];

function showChallengeMenu() {
  const area = $('chalArea');
  area.innerHTML = '';
  $('chalTitle').textContent = '⚡ Games';
  const stats = document.createElement('div');
  stats.style.cssText = 'display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;';
  stats.innerHTML = '<span style="font-family:\'Courier New\',monospace;font-size:10px;color:rgba(255,255,255,0.28);letter-spacing:1.5px;text-transform:uppercase;">Your progress</span>'
    + '<span style="font-family:\'Courier New\',monospace;font-size:13px;color:#e8c870;font-weight:bold;">&#9889; ' + xp + ' XP &#128293; ' + streak + '</span>';
  area.appendChild(stats);
  const grid = document.createElement('div');
  grid.className = 'chal-grid';
  CHALLENGE_TYPES.forEach(function(ct) {
    const card = document.createElement('div');
    card.className = 'chal-card ' + ct.cls;
    card.innerHTML = '<span class="cc-ico">' + ct.ico + '</span>'
      + '<span class="cc-name">' + ct.name + '</span>'
      + '<span class="cc-desc">' + ct.desc + '</span>'
      + '<span class="cc-xp">+' + ct.xp + ' XP</span>';
    card.onclick = (function(id) { return function() { startChallenge(id); }; })(ct.id);
    grid.appendChild(card);
  });
  area.appendChild(grid);
}

function exitChallenge() {
  clearChalTimer();
  syn.cancel();
  updateXPBar();
  updateStreakBadge();
  showScreen('Picker');
  $('lvRow').style.display = 'none';
}

let chalType = '', chalRound = 0, chalTotal = 5, chalScore = 0;
let chalTimerInterval = null, chalTimeLeft = 0;

function clearChalTimer() {
  if (chalTimerInterval) { clearInterval(chalTimerInterval); chalTimerInterval = null; }
}

function startChallenge(type) {
  chalType = type; chalRound = 0; chalScore = 0;
  const ct = CHALLENGE_TYPES.find(function(c) { return c.id === type; });
  $('chalTitle').textContent = ct.ico + ' ' + ct.name;
  buildChalRound();
}

function buildChalRound() {
  if (chalRound >= chalTotal) { showChalSummary(); return; }
  if (chalType === 'scramble') buildScramble();
  else if (chalType === 'build') buildSentBuilder();
  else if (chalType === 'odd') buildOddOne();
  else if (chalType === 'quick') buildQuickFire();
  else if (chalType === 'trans') buildTransMatch();
  else if (chalType === 'spell') buildSpellBee();
  else if (chalType === 'mahjong') buildMahjong();
}

function renderChalFrame(html, withTimer) {
  const ct = CHALLENGE_TYPES.find(function(c) { return c.id === chalType; });
  $('chalArea').innerHTML =
    '<div class="chal-active">'
    + '<div class="chal-type-header">'
    + '<span class="chal-type-ico">' + ct.ico + '</span>'
    + '<div><div class="chal-type-name">' + ct.name + '</div>'
    + '<div class="chal-round">Round ' + (chalRound+1) + ' of ' + chalTotal + '</div></div>'
    + '</div>'
    + (withTimer ? '<div class="chal-timer-bar"><div class="chal-timer-fill" id="chalTimerFill" style="width:100%"></div></div>' : '')
    + '<div id="chalQ">' + html + '</div>'
    + '</div>';
}

function startTimer(secs, onTimeout) {
  clearChalTimer();
  chalTimeLeft = secs;
  chalTimerInterval = setInterval(function() {
    chalTimeLeft--;
    const f = $('chalTimerFill');
    if (f) f.style.width = (chalTimeLeft / secs * 100) + '%';
    if (chalTimeLeft <= 0) { clearChalTimer(); onTimeout(); }
  }, 1000);
}

function showFb(type, html) {
  const fb = $('chalFb');
  if (fb) { fb.className = 'chal-fb ' + type; fb.innerHTML = html; }
}

function showNextBtn() { const b = $('chalNextBtn'); if (b) b.classList.add('vis'); }
function nextChalRound() { chalRound++; buildChalRound(); }

/* WORD SCRAMBLE */
function buildScramble() {
  const card = getRandCards(chalTotal * 2)[chalRound];
  const words = card.en.replace(/[.,!?]/g, '').split(/\s+/).filter(function(w) { return w.length > 3; });
  const target = words[Math.floor(Math.random() * words.length)] || 'school';
  let sc = target.split('').sort(function() { return Math.random()-0.5; }).join('');
  if (sc === target) sc = target.split('').reverse().join('');
  renderChalFrame(
    '<div class="chal-q-box">'
    + '<div class="chal-prompt">Unscramble the word</div>'
    + '<div class="chal-question" style="font-size:2rem;letter-spacing:6px;color:#6ab4f5">' + sc.toUpperCase() + '</div>'
    + '<div class="chal-sub">From: <em>"' + card.en + '"</em></div>'
    + '<input class="chal-input" id="chalInput" type="text" placeholder="Type the word..." autocomplete="off" autocorrect="off" spellcheck="false" data-answer="' + target.toLowerCase() + '" onkeydown="if(event.key===\'Enter\') checkScramble()" oninput="$(&apos;chalCheckBtn&apos;).disabled=!this.value.trim()" />'
    + '<button class="chal-check-btn" id="chalCheckBtn" disabled onclick="checkScramble()">Check &#10003;</button>'
    + '<div class="chal-fb" id="chalFb"></div>'
    + '<button class="chal-next-btn" id="chalNextBtn" onclick="nextChalRound()">Next &#8594;</button>'
    + '</div>'
  , false);
  setTimeout(function() { const i=$('chalInput'); if(i) i.focus(); }, 200);
}

function checkScramble() {
  const inp = $('chalInput');
  const val = inp.value.trim().toLowerCase();
  const correct = inp.dataset.answer;
  inp.disabled = true; $('chalCheckBtn').disabled = true;
  if (val === correct) {
    inp.className = 'chal-input correct'; chalScore++;
    awardXP(4, window.innerWidth/2, 200);
    showFb('correct', '&#10024; Correct! <strong>' + correct + '</strong>');
  } else {
    inp.className = 'chal-input wrong';
    showFb('wrong', 'The word was <strong>' + correct + '</strong>');
  }
  showNextBtn();
}

/* SENTENCE BUILDER */
var sbPlaced = [], sbRemaining = [];

function buildSentBuilder() {
  const card = getRandCards(chalTotal * 2)[chalRound];
  const words = card.en.replace(/[.,!?]/g,'').split(/\s+/);
  if (words.length > 9) { chalRound++; buildChalRound(); return; }
  sbPlaced = []; sbRemaining = words.slice().sort(function() { return Math.random()-0.5; });
  const target = words.join(' ');
  renderChalFrame(
    '<div class="chal-q-box">'
    + '<div class="chal-prompt">Tap words in the correct order</div>'
    + '<div class="chal-sub" style="margin-bottom:14px">' + card.sr + '</div>'
    + '<div class="chal-slot-area" id="sbSlot"></div>'
    + '<div class="chal-tiles" id="sbTiles"></div>'
    + '<button class="chal-check-btn" id="chalCheckBtn" disabled onclick="checkSentBuilder(\'' + target.replace(/'/g,"\\'") + '\')">Check &#10003;</button>'
    + '<div class="chal-fb" id="chalFb"></div>'
    + '<button class="chal-next-btn" id="chalNextBtn" onclick="nextChalRound()">Next &#8594;</button>'
    + '</div>'
  , false);
  renderSBTiles();
}

function renderSBTiles() {
  const slot = $('sbSlot'), tiles = $('sbTiles');
  if (!slot || !tiles) return;
  slot.innerHTML = ''; tiles.innerHTML = '';
  sbPlaced.forEach(function(w, i) {
    const t = document.createElement('span');
    t.className = 'tile placed'; t.textContent = w;
    t.onclick = (function(idx) { return function() { sbRemaining.push(sbPlaced.splice(idx,1)[0]); renderSBTiles(); updateSBBtn(); }; })(i);
    slot.appendChild(t);
  });
  sbRemaining.forEach(function(w, i) {
    const t = document.createElement('span');
    t.className = 'tile'; t.textContent = w;
    t.onclick = (function(idx) { return function() { sbPlaced.push(sbRemaining.splice(idx,1)[0]); renderSBTiles(); updateSBBtn(); }; })(i);
    tiles.appendChild(t);
  });
}

function updateSBBtn() { const b=$('chalCheckBtn'); if(b) b.disabled = sbRemaining.length > 0; }

function checkSentBuilder(target) {
  $('chalCheckBtn').disabled = true;
  const built = sbPlaced.join(' ');
  const tiles = document.querySelectorAll('#sbSlot .tile');
  if (built.toLowerCase() === target.toLowerCase()) {
    tiles.forEach(function(t) { t.className='tile correct-tile'; });
    chalScore++; awardXP(6, window.innerWidth/2, 200);
    showFb('correct', '&#127881; Perfect sentence!');
  } else {
    tiles.forEach(function(t) { t.className='tile wrong-tile'; });
    showFb('wrong', 'Correct order: <strong>' + target + '</strong>');
  }
  showNextBtn();
}

/* ODD ONE OUT */
const ODD_SETS = [
  { q:'Which word is a VERB?',            opts:['run','happy','book','cold'],              ans:'run' },
  { q:'Which word is an ADJECTIVE?',      opts:['swim','tall','school','eat'],             ans:'tall' },
  { q:'Which is a PREPOSITION?',          opts:['dog','under','apple','jump'],             ans:'under' },
  { q:'Which does NOT belong (animals)?', opts:['cat','dog','chair','bird'],               ans:'chair' },
  { q:'Which word is a NOUN?',            opts:['quickly','beautiful','mountain','carefully'], ans:'mountain' },
  { q:'Which word is an ADVERB?',         opts:['slowly','red','tree','run'],              ans:'slowly' },
  { q:'Which does NOT belong (colours)?', opts:['blue','red','heavy','green'],             ans:'heavy' },
  { q:'Which is a PLURAL noun?',          opts:['children','he','quickly','beautiful'],   ans:'children' },
  { q:'Which word is a CONJUNCTION?',     opts:['table','and','happy','run'],              ans:'and' },
  { q:'Which does NOT belong (school)?',  opts:['pencil','ruler','elephant','notebook'],  ans:'elephant' },
];

function buildOddOne() {
  const set = ODD_SETS[chalRound % ODD_SETS.length];
  const opts = set.opts.slice().sort(function() { return Math.random()-0.5; });
  renderChalFrame(
    '<div class="chal-q-box">'
    + '<div class="chal-prompt">Find the odd one out</div>'
    + '<div class="chal-question">' + set.q + '</div>'
    + '<div class="chal-options">'
    + opts.map(function(o) { return '<div class="chal-opt" onclick="checkOdd(this,\'' + o + '\',\'' + set.ans + '\')">' + o + '</div>'; }).join('')
    + '</div>'
    + '<div class="chal-fb" id="chalFb"></div>'
    + '<button class="chal-next-btn" id="chalNextBtn" onclick="nextChalRound()">Next &#8594;</button>'
    + '</div>'
  , false);
}

function checkOdd(el, chosen, ans) {
  document.querySelectorAll('.chal-opt').forEach(function(o) { o.className='chal-opt faded'; });
  if (chosen === ans) {
    el.className = 'chal-opt correct'; chalScore++;
    awardXP(4, el.getBoundingClientRect().left+40, el.getBoundingClientRect().top);
    showFb('correct', '&#9989; Correct! <strong>' + ans + '</strong> is the odd one out.');
  } else {
    el.className = 'chal-opt wrong';
    document.querySelectorAll('.chal-opt').forEach(function(o) { if(o.textContent===ans) o.className='chal-opt reveal'; });
    showFb('wrong', 'The odd one out was <strong>' + ans + '</strong>.');
  }
  showNextBtn();
}

/* QUICK FIRE */
function buildQuickFire() {
  const cards = getRandCards(chalTotal * 3);
  const card = cards[chalRound];
  const wordList = card.en.replace(/[.,!?'"]/g,'').split(/\s+/).filter(function(w) { return w.length > 3; });
  const correct = wordList[Math.floor(Math.random()*wordList.length)] || 'school';
  const esc = correct.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
  const pool = Array.from(new Set(getAllCards().map(function(c) {
    return c.en.replace(/[.,!?'"]/g,'').split(/\s+/);
  }).reduce(function(a,b) { return a.concat(b); },[]).filter(function(w) { return w.length > 3 && w.toLowerCase() !== correct.toLowerCase(); })));
  const opts = [correct].concat(pool.sort(function() { return Math.random()-0.5; }).slice(0,3)).sort(function() { return Math.random()-0.5; });
  const display = card.en.replace(new RegExp('\\b'+esc+'\\b','i'), '<span style="color:#d4a843;font-weight:bold">___</span>');

  renderChalFrame(
    '<div class="chal-q-box">'
    + '<div class="chal-prompt">Which word fills the gap?</div>'
    + '<div class="chal-question">' + display + '</div>'
    + '<div class="chal-sub">' + card.sr + '</div>'
    + '<div class="chal-options">'
    + opts.map(function(o) { return '<div class="chal-opt" onclick="checkQuickFire(this,\'' + o.replace(/'/g,"\\'") + '\',\'' + correct.replace(/'/g,"\\'") + '\')">' + o + '</div>'; }).join('')
    + '</div>'
    + '<div class="chal-fb" id="chalFb"></div>'
    + '<button class="chal-next-btn" id="chalNextBtn" onclick="nextChalRound()">Next &#8594;</button>'
    + '</div>'
  , true);

  startTimer(12, function() {
    document.querySelectorAll('.chal-opt').forEach(function(o) { o.className='chal-opt faded'; });
    document.querySelectorAll('.chal-opt').forEach(function(o) { if(o.textContent===correct) o.className='chal-opt reveal'; });
    showFb('wrong', '&#9201; Time up! Answer: <strong>' + correct + '</strong>');
    showNextBtn();
  });
}

function checkQuickFire(el, chosen, ans) {
  clearChalTimer();
  document.querySelectorAll('.chal-opt').forEach(function(o) { o.className='chal-opt faded'; });
  if (chosen === ans) {
    el.className = 'chal-opt correct'; chalScore++;
    const bonus = chalTimeLeft >= 8 ? 6 : 3;
    awardXP(bonus, el.getBoundingClientRect().left+40, el.getBoundingClientRect().top);
    showFb('correct', '&#9889; Correct! +' + bonus + ' XP' + (chalTimeLeft>=8?' (speed bonus!)':''));
  } else {
    el.className = 'chal-opt wrong';
    document.querySelectorAll('.chal-opt').forEach(function(o) { if(o.textContent===ans) o.className='chal-opt reveal'; });
    showFb('wrong', 'The answer was <strong>' + ans + '</strong>.');
  }
  showNextBtn();
}

/* TRANSLATION MATCH */
function buildTransMatch() {
  const cards = getRandCards(4);
  const target = cards[0];
  const opts = cards.map(function(c) { return c.sr; }).sort(function() { return Math.random()-0.5; });
  const correctIdx = opts.indexOf(target.sr);
  renderChalFrame(
    '<div class="chal-q-box" data-trans-correct="' + correctIdx + '">'
    + '<div class="chal-prompt">Pick the Serbian translation</div>'
    + '<div class="chal-question">"' + target.en + '"</div>'
    + '<div style="height:10px"></div>'
    + '<div class="chal-options" style="grid-template-columns:1fr;">'
    + opts.map(function(o, i) { return '<div class="chal-opt" onclick="checkTrans(this,' + i + ',' + correctIdx + ')">' + o + '</div>'; }).join('')
    + '</div>'
    + '<div class="chal-fb" id="chalFb"></div>'
    + '<button class="chal-next-btn" id="chalNextBtn" onclick="nextChalRound()">Next &#8594;</button>'
    + '</div>'
  , false);
}

function checkTrans(el, idx, correctIdx) {
  const allOpts = document.querySelectorAll('.chal-opt');
  allOpts.forEach(function(o) { o.className='chal-opt faded'; });
  if (idx === correctIdx) {
    el.className = 'chal-opt correct'; chalScore++;
    awardXP(5, el.getBoundingClientRect().left+40, el.getBoundingClientRect().top);
    showFb('correct', '&#127757; Correct translation!');
  } else {
    el.className = 'chal-opt wrong';
    allOpts[correctIdx].className = 'chal-opt reveal';
    showFb('wrong', 'That was not the right translation.');
  }
  showNextBtn();
}

/* SPELLING BEE */
function buildSpellBee() {
  const card = getRandCards(chalTotal * 2)[chalRound];
  const words = card.en.replace(/[.,!?]/g,'').split(/\s+/).filter(function(w) { return w.length > 3; });
  const target = words[Math.floor(Math.random()*words.length)] || 'school';
  renderChalFrame(
    '<div class="chal-q-box">'
    + '<div class="chal-prompt">Listen and spell the word</div>'
    + '<div style="font-family:Georgia,serif;font-style:italic;font-size:13px;color:rgba(212,168,67,0.6);margin-bottom:16px;">"' + card.en + '"</div>'
    + '<button onclick="speakSpellWord(\'' + target + '\')" style="display:block;width:100%;padding:12px;border-radius:12px;background:rgba(255,220,80,0.1);border:1.5px solid rgba(255,220,80,0.25);color:#e8c870;font-family:Georgia,serif;font-size:14px;cursor:pointer;margin-bottom:14px;">&#128266; Hear the word again</button>'
    + '<input class="chal-input" id="chalInput" type="text" placeholder="Spell it..." autocomplete="off" autocorrect="off" spellcheck="false" data-answer="' + target.toLowerCase() + '" onkeydown="if(event.key===\'Enter\') checkSpell()" oninput="$(&apos;chalCheckBtn&apos;).disabled=!this.value.trim()" />'
    + '<button class="chal-check-btn" id="chalCheckBtn" disabled onclick="checkSpell()">Check &#10003;</button>'
    + '<div class="chal-fb" id="chalFb"></div>'
    + '<button class="chal-next-btn" id="chalNextBtn" onclick="nextChalRound()">Next &#8594;</button>'
    + '</div>'
  , false);
  speakSpellWord(target);
  setTimeout(function() { const i=$('chalInput'); if(i) i.focus(); }, 700);
}

function speakSpellWord(word) {
  syn.cancel();
  const u = new SpeechSynthesisUtterance(word);
  u.lang='en-US'; u.rate=0.72; u.pitch=1.05;
  const v=getVoice(); if(v) u.voice=v;
  syn.speak(u);
}

function checkSpell() {
  const inp = $('chalInput');
  const val = inp.value.trim().toLowerCase();
  const correct = inp.dataset.answer;
  inp.disabled = true; $('chalCheckBtn').disabled = true;
  if (val === correct) {
    inp.className = 'chal-input correct'; chalScore++;
    awardXP(6, window.innerWidth/2, 200);
    showFb('correct', '&#9999; Perfect spelling! <strong>' + correct + '</strong>');
  } else {
    inp.className = 'chal-input wrong';
    showFb('wrong', 'Correct spelling: <strong>' + correct + '</strong>');
  }
  showNextBtn();
}

/* SUMMARY */

/* ═══════════════════════════════════════
   WORD MAHJONG — Flip & Match
   16 tiles (4×4), 8 EN/SR pairs
   Match each English word to its Serbian
═══════════════════════════════════════ */

var MJ = {
  tiles:    [],   // [{id, pairId, lang, label, el}]
  flipped:  [],   // indices of face-up unmatched tiles (max 2)
  matched:  0,    // number of matched pairs
  moves:    0,
  seconds:  0,
  timer:    null,
  lock:     false,
  total:    8     // pairs
};

function buildMahjong() {
  clearInterval(MJ.timer);
  MJ.flipped = []; MJ.matched = 0; MJ.moves = 0; MJ.seconds = 0; MJ.lock = false;

  // Pick MJ.total random cards, build tile objects
  var pool = getAllCards().sort(function(){ return Math.random()-0.5; }).slice(0, MJ.total);
  var rawTiles = [];
  pool.forEach(function(card, pairIdx) {
    // Shorten labels to fit tile
    var en = card.en.replace(/[.,!?]/g,'').split(' ').slice(0,4).join(' ');
    var sr = card.sr.replace(/[.,!?]/g,'').split(' ').slice(0,3).join(' ');
    rawTiles.push({ pairId: pairIdx, lang:'en', label: en });
    rawTiles.push({ pairId: pairIdx, lang:'sr', label: sr });
  });
  rawTiles = rawTiles.sort(function(){ return Math.random()-0.5; });

  // Build DOM
  var area = $('chalArea');
  area.innerHTML = '';

  var wrap = document.createElement('div');
  wrap.className = 'mj-wrap';
  wrap.innerHTML =
    '<div class="mj-header">'
    + '<div class="mj-header-icon">\uD83C\uDC04</div>'
    + '<div class="mj-header-text">'
    +   '<div class="mj-h-title">Word Mahjong</div>'
    +   '<div class="mj-h-sub">Match English \u2194 Serbian &middot; 8 pairs</div>'
    + '</div>'
    + '</div>'
    + '<div class="mj-scorebar">'
    +   '<div class="mj-score-item"><div class="mj-score-val" id="mjMoves">0</div><div class="mj-score-lbl">Moves</div></div>'
    +   '<div class="mj-score-item"><div class="mj-score-val" id="mjPairs">0/8</div><div class="mj-score-lbl">Pairs</div></div>'
    +   '<div class="mj-score-item"><div class="mj-score-val" id="mjTime">0:00</div><div class="mj-score-lbl">Time</div></div>'
    + '</div>'
    + '<div class="mj-grid" id="mjGrid"></div>'
    + '<div class="mj-progress-wrap">'
    +   '<div class="mj-progress-top"><span>Progress</span><span id="mjPct">0%</span></div>'
    +   '<div class="mj-progress-track"><div class="mj-progress-fill" id="mjFill" style="width:0%"></div></div>'
    + '</div>';
  area.appendChild(wrap);

  var grid = $('mjGrid');
  MJ.tiles = [];

  rawTiles.forEach(function(t, i) {
    var el = document.createElement('div');
    el.className = 'mj-tile';
    // Back face
    var back = document.createElement('div');
    back.className = 'mj-tile-back';
    back.textContent = '\uD83C\uDC04';   // 🀄 mahjong tile Unicode
    // Front face
    var front = document.createElement('div');
    front.className = 'mj-tile-front lang-' + t.lang;
    front.textContent = t.label;

    el.appendChild(back);
    el.appendChild(front);
    el.onclick = (function(idx){ return function(){ mjFlip(idx); }; })(i);
    grid.appendChild(el);

    MJ.tiles.push({ pairId: t.pairId, lang: t.lang, label: t.label, el: el });
  });

  // Timer
  MJ.timer = setInterval(function(){
    MJ.seconds++;
    var el = $('mjTime');
    if (el) el.textContent = Math.floor(MJ.seconds/60) + ':' + ('0' + MJ.seconds%60).slice(-2);
  }, 1000);
}

function mjFlip(idx) {
  if (MJ.lock) return;
  var tile = MJ.tiles[idx];
  if (!tile || tile.el.classList.contains('is-flipped') || tile.el.classList.contains('is-matched')) return;

  // Flip it
  tile.el.classList.add('is-flipped');
  MJ.flipped.push(idx);

  if (MJ.flipped.length < 2) return;

  // Two flipped — evaluate
  MJ.lock = true;
  MJ.moves++;
  var movEl = $('mjMoves'); if (movEl) movEl.textContent = MJ.moves;

  var ia = MJ.flipped[0], ib = MJ.flipped[1];
  var ta = MJ.tiles[ia],  tb = MJ.tiles[ib];

  if (ta.pairId === tb.pairId && ta.lang !== tb.lang) {
    // ✅ Match
    MJ.matched++;
    var pct = Math.round(MJ.matched / MJ.total * 100);
    var pEl = $('mjPairs'); if (pEl) pEl.textContent = MJ.matched + '/' + MJ.total;
    var fEl = $('mjFill');  if (fEl) fEl.style.width = pct + '%';
    var pcEl = $('mjPct');  if (pcEl) pcEl.textContent = pct + '%';

    setTimeout(function(){
      [ta, tb].forEach(function(t){
        t.el.classList.add('is-matched', 'is-pop');
      });
      awardXP(2, window.innerWidth/2, 180);
      MJ.flipped = [];
      MJ.lock = false;
      if (MJ.matched === MJ.total) setTimeout(mjComplete, 650);
    }, 320);

  } else {
    // ❌ No match — shake, then flip back
    setTimeout(function(){
      [ta, tb].forEach(function(t){ t.el.classList.add('is-wrong'); });
      setTimeout(function(){
        [ta, tb].forEach(function(t){
          t.el.classList.remove('is-flipped', 'is-wrong');
        });
        MJ.flipped = [];
        MJ.lock = false;
      }, 420);
    }, 650);
  }
}

function mjComplete() {
  clearInterval(MJ.timer);

  // XP: based on moves efficiency (optimal = 16 moves for 8 pairs)
  var xpBonus = MJ.moves <= 12 ? 30
              : MJ.moves <= 18 ? 22
              : MJ.moves <= 26 ? 14 : 8;
  awardXP(xpBonus, window.innerWidth/2, window.innerHeight/3);
  updateXPBar();

  var stars = MJ.moves <= 12 ? '\u2605\u2605\u2605'
            : MJ.moves <= 18 ? '\u2605\u2605\u2606'
            :                   '\u2605\u2606\u2606';
  var msg   = MJ.moves <= 12 ? 'Incredible memory!'
            : MJ.moves <= 18 ? 'Well matched!'
            :                   'Board cleared!';
  var timeStr = Math.floor(MJ.seconds/60) + ':' + ('0' + MJ.seconds%60).slice(-2);

  var area = $('chalArea');
  area.innerHTML = '';
  var card = document.createElement('div');
  card.className = 'mj-complete';
  card.innerHTML =
    '<div class="mj-complete-icon">\uD83C\uDC04</div>'
    + '<div class="mj-complete-title">' + msg + '</div>'
    + '<div class="mj-complete-sub">All 8 pairs matched</div>'
    + '<span class="mj-star">' + stars + '</span>'
    + '<div class="mj-stat-row">'
    +   '<div class="mj-stat-cell"><div class="sv">' + MJ.moves + '</div><div class="sl">Moves</div></div>'
    +   '<div class="mj-stat-cell"><div class="sv">' + timeStr + '</div><div class="sl">Time</div></div>'
    +   '<div class="mj-stat-cell"><div class="sv" style="color:#e8c870">+' + xpBonus + '</div><div class="sl">XP</div></div>'
    + '</div>'
    + '<button class="gf-sum-btn" onclick="buildMahjong()">'
    +   'Play again \u21BA'
    + '</button>'
    + '<button class="gf-sum-btn sec" style="margin-top:10px" onclick="showChallengeMenu()">'
    +   'All challenges'
    + '</button>';
  area.appendChild(card);

  showToast('\uD83C\uDC04 ' + msg + ' +' + xpBonus + ' XP');
}

function showChalSummary() {
  clearChalTimer();
  const ct = CHALLENGE_TYPES.find(function(c) { return c.id === chalType; });
  const xpEarned = Math.round(ct.xp * chalScore / chalTotal);
  awardXP(xpEarned, window.innerWidth/2, window.innerHeight/3);
  updateXPBar();
  const pct = Math.round(chalScore / chalTotal * 100);
  const icon = pct === 100 ? '&#127942;' : pct >= 60 ? '&#11088;' : '&#128170;';
  const msg  = pct === 100 ? 'Perfect score! You nailed every one!'
             : pct >= 60   ? 'Great work — keep it up!'
             :                'Good effort — try again to beat your score!';
  $('chalArea').innerHTML =
    '<div style="text-align:center;padding:50px 20px;">'
    + '<div style="font-size:64px;margin-bottom:16px;animation:popIn 0.6s cubic-bezier(0.34,1.56,0.64,1)">' + icon + '</div>'
    + '<div style="font-family:Georgia,serif;font-size:2.2rem;font-weight:bold;color:#d4a843;margin-bottom:6px;">' + chalScore + ' / ' + chalTotal + '</div>'
    + '<div style="font-family:\'Courier New\',monospace;font-size:10px;color:rgba(255,255,255,0.28);letter-spacing:2px;margin-bottom:14px;">' + pct + '% CORRECT</div>'
    + '<div style="font-size:14px;color:rgba(255,255,255,0.5);margin-bottom:8px;">' + msg + '</div>'
    + '<div style="font-family:\'Courier New\',monospace;font-size:13px;color:#e8c870;margin-bottom:30px;">+' + xpEarned + ' XP &nbsp;&middot;&nbsp; Total: ' + xp + ' XP &nbsp;&middot;&nbsp; &#128293; ' + streak + ' day streak</div>'
    + '<button class="gf-sum-btn" onclick="startChallenge(\'' + chalType + '\')">Play again</button>'
    + '<button class="gf-sum-btn sec" style="margin-top:8px;" onclick="showChallengeMenu()">All challenges</button>'
    + '</div>';
  showToast(msg + ' +' + xpEarned + ' XP');
}

syn.onvoiceschanged=()=>syn.getVoices();
initApp();


/* ════════════════════════════════════════
   CONVERSATION MODE
════════════════════════════════════════ */

const TOPICS = {
  basketball: {
    icon:'🏀', name:'Basketball',
    sentences:[
      { en:"Basketball is a team sport played with five players.",           sr:"Кошарка је тимски спорт са пет играча." },
      { en:"The player shoots the ball into the basket.",                    sr:"Играч баца лопту у кош." },
      { en:"Michael Jordan is one of the greatest players of all time.",     sr:"Мајкл Џордан је један од највећих играча свих времена." },
      { en:"The NBA is the top professional basketball league in the world.", sr:"НБА је највиша професионална кошаркашка лига на свету." },
      { en:"A three-point shot is worth more than a regular basket.",        sr:"Трица вреди више од обичног поена." },
      { en:"Defense is just as important as offense in basketball.",         sr:"Одбрана је подједнако важна као и напад у кошарци." },
      { en:"The team with the most points at the end wins the game.",        sr:"Тим са највише поена на крају побеђује." },
    ]
  },
  movies: {
    icon:'🎬', name:'Movies',
    sentences:[
      { en:"Movies tell stories through images and sound.",                  sr:"Филмови причају приче кроз слике и звук." },
      { en:"The director is responsible for the creative vision of a film.", sr:"Редитељ је одговоран за уметничку визију филма." },
      { en:"Actors bring characters to life on the screen.",                 sr:"Глумци оживљавају ликове на екрану." },
      { en:"A blockbuster is a very popular and commercially successful film.",sr:"Блокбастер је веома популаран и комерцијално успешан филм." },
      { en:"Subtitles help viewers understand films in foreign languages.",   sr:"Титлови помажу гледаоцима да разумеју филмове на страним језицима." },
      { en:"The soundtrack of a film can make it more emotional.",           sr:"Музика у филму може да га учини емотивнијим." },
      { en:"Film festivals celebrate the best movies from around the world.", sr:"Филмски фестивали славе најбоље филмове из целог света." },
    ]
  },
  sports: {
    icon:'⚽', name:'Sports',
    sentences:[
      { en:"Sport is good for your health and well-being.",                  sr:"Спорт је добар за здравље и добробит." },
      { en:"Football is the most popular sport in the world.",               sr:"Фудбал је најпопуларнији спорт на свету." },
      { en:"Athletes train hard every day to improve their performance.",    sr:"Спортисти вежбају напорно сваки дан да побољшају своје резултате." },
      { en:"The Olympics bring together athletes from every country.",       sr:"Олимпијске игре окупљају спортисте из свих земаља." },
      { en:"A referee makes sure the players follow the rules.",             sr:"Судија осигурава да играчи прате правила." },
      { en:"Teamwork is essential in most team sports.",                     sr:"Тимски рад је неопходан у већини тимских спортова." },
      { en:"Records are broken by athletes who push their limits.",          sr:"Рекорде оборају спортисти који превазилазе своје границе." },
    ]
  },
  geography: {
    icon:'🌍', name:'Geography',
    sentences:[
      { en:"The Earth is divided into seven continents.",                    sr:"Земља је подељена на седам континената." },
      { en:"The Nile is the longest river in the world.",                    sr:"Нил је најдужа река на свету." },
      { en:"Mount Everest is the highest mountain on Earth.",                sr:"Монт Евeрест је највиша планина на Земљи." },
      { en:"Paris is the capital city of France.",                           sr:"Париз је главни град Француске." },
      { en:"The Pacific Ocean is the largest ocean on the planet.",          sr:"Тихи океан је највећи океан на планети." },
      { en:"Brazil is the largest country in South America.",                sr:"Бразил је највећа земља у Јужној Америци." },
      { en:"Deserts receive very little rainfall each year.",                sr:"Пустиње добијају врло мало падавина сваке године." },
    ]
  },
  languages: {
    icon:'💬', name:'Languages',
    sentences:[
      { en:"There are over seven thousand languages spoken in the world.",   sr:"У свету се говори преко седам хиљада језика." },
      { en:"Learning a new language opens many doors.",                      sr:"Учење новог језика отвара многа врата." },
      { en:"Mandarin Chinese has the most native speakers in the world.",    sr:"Мандарински кинески има највише матерњих говорника на свету." },
      { en:"English is used as a global language for communication.",        sr:"Енглески се користи као глобални језик комуникације." },
      { en:"Bilingual people can switch between two languages easily.",      sr:"Двојезични људи лако прелазе с једног језика на други." },
      { en:"Children learn languages much faster than adults.",              sr:"Деца уче језике много брже него одрасли." },
      { en:"Practice every day is the best way to improve your speaking.",   sr:"Свакодневна пракса је најбољи начин да побољшаш говор." },
    ]
  }
};

let convTopic = null;
let convSentences = [];
let convIndex = 0;
let convAttempts = 0;
let recognition = null;
let isListening = false;
let convCompleted = [];


function startConv(topic) {
  convTopic = topic;
  const t = TOPICS[topic];
  convSentences = [...t.sentences];
  convIndex = 0;
  convAttempts = 0;
  convCompleted = [];

  $('convTopicBadge').innerHTML = t.icon + ' <strong>' + t.name + '</strong>';
  $('chatArea').innerHTML = '';
  updateConvProgress();
  $('repeatCard').style.display = 'none';
  $('playAgainBtn').style.display = 'none';
  $('micBtn').disabled = true;
  $('micBtn').style.opacity = '0.3';

  showScreen('Conv');
  $('lvRow').style.display = 'none';

  // Greet and introduce first sentence after a beat
  setTimeout(() => {
    addBubble('tutor', `Hello${userName ? ', <strong>'+userName+'</strong>' : ''}! Let's practice English together. Today's topic is <strong>${t.name}</strong>. I'll say a sentence — listen carefully, then repeat it into your microphone. Ready? Here we go!`);
    setTimeout(() => presentSentence(), 1800);
  }, 400);
}

function exitConv() {
  if (recognition) { try { recognition.stop(); } catch(e){} }
  isListening = false;
  syn.cancel();
  showScreen('Picker');
  $('lvRow').style.display = 'none';
  resetMicUI();
}

function presentSentence() {
  if (convIndex >= convSentences.length) { convFinished(); return; }
  const s = convSentences[convIndex];
  convAttempts = 0;

  // Show repeat card
  $('repeatCard').style.display = 'block';
  $('repeatSentence').textContent = s.en;
  $('repeatSr').textContent = s.sr;
  $('playAgainBtn').style.display = 'block';
  $('micBtn').style.display = 'inline-flex';
  $('micStatus').textContent = 'Press the mic and repeat the sentence';
  $('transcriptPreview').textContent = '';
  $('micBtn').disabled = false;
  $('micBtn').style.opacity = '1';

  // Tutor speaks it
  addBubble('tutor', `<em>"${s.en}"</em><br><small style="opacity:0.5;font-size:12px">${s.sr}</small>`);
  setTimeout(() => speakTutor(s.en), 600);
}

function playCurrentSentence() {
  if (convIndex < convSentences.length) {
    speakTutor(convSentences[convIndex].en);
  }
}

function speakTutor(text, cb) {
  syn.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'en-US'; u.rate = 0.82; u.pitch = 1.05;
  const v = getVoice(); if(v) u.voice = v;
  if (cb) u.onend = cb;
  syn.speak(u);
}

function toggleMic() {
  if (isListening) stopListening();
  else startListening();
}

function startListening() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    showMicStatus('⚠ Speech recognition not supported. Use Chrome or Edge.', 'error');
    return;
  }

  syn.cancel();
  isListening = true;
  setMicUI('listening');

  // Longer delay so browser audio pipeline fully releases TTS
  setTimeout(() => {
    if (!isListening) return; // user cancelled

    recognition = new SR();
    recognition.lang = 'en-US';
    recognition.continuous = true;      // keep listening until user stops
    recognition.interimResults = true;
    recognition.maxAlternatives = 5;

    let finalTranscript = '';
    let gotSpeech = false;

    recognition.onresult = (e) => {
      let interim = '';
      for (let i = e.resultIndex; i < e.results.length; i++) {
        if (e.results[i].isFinal) {
          finalTranscript += e.results[i][0].transcript + ' ';
          gotSpeech = true;
        } else {
          interim += e.results[i][0].transcript;
        }
      }
      $('transcriptPreview').textContent = finalTranscript.trim() || interim;

      // Auto-stop after we have a final result (give 1s for more speech)
      if (gotSpeech) {
        clearTimeout(recognition._autoStop);
        recognition._autoStop = setTimeout(() => {
          if (isListening) stopListening();
        }, 1000);
      }
    };

    recognition.onend = () => {
      if (!isListening) return; // already handled by stopListening
      isListening = false;
      setMicUI('idle');
      const result = finalTranscript.trim();
      if (result) {
        evaluateAnswer(result);
      } else {
        // no-speech fired: stay open, let user try again
        showMicStatus('Tap mic again and speak clearly 🎤', 'hint');
      }
    };

    recognition.onerror = (e) => {
      if (e.error === 'no-speech') {
        // Don't stop — just prompt user to try again
        showMicStatus('Tap the mic button and speak clearly 🎤', 'hint');
        isListening = false;
        setMicUI('idle');
        return;
      }
      isListening = false;
      setMicUI('idle');
      if (e.error === 'not-allowed') {
        showMicStatus('⚠ Mic blocked — allow microphone in browser settings', 'error');
      } else if (e.error === 'aborted') {
        // user stopped manually, ignore
      } else {
        showMicStatus('Mic error: ' + e.error + ' — tap to try again', 'error');
      }
    };

    try {
      recognition.start();
    } catch(err) {
      isListening = false;
      setMicUI('idle');
      showMicStatus('Could not start mic — tap to try again', 'error');
    }
  }, 600); // 600ms gap gives browser time to fully close TTS audio
}

function stopListening() {
  if (recognition) { try { recognition.abort(); } catch(e){} recognition = null; }
  isListening = false;
  setMicUI('idle');
}

function setMicUI(state) {
  const btn = $('micBtn');
  if (state === 'listening') {
    btn.textContent = '⏹';
    btn.classList.add('listening');
    showMicStatus('🔴 Listening… speak now', 'active');
    $('transcriptPreview').textContent = '';
  } else {
    btn.textContent = '🎤';
    btn.classList.remove('listening');
    if ($('micStatus').dataset.state !== 'error') {
      showMicStatus('Press the mic and repeat the sentence', 'hint');
    }
  }
}

function showMicStatus(msg, state) {
  const el = $('micStatus');
  el.textContent = msg;
  el.dataset.state = state;
  el.className = 'mic-status' + (state === 'active' ? ' active' : state === 'error' ? ' error' : '');
}

function resetMicUI() {
  stopListening();
  $('transcriptPreview').textContent = '';
  showMicStatus('Press the mic and repeat the sentence', 'hint');
}

function addBubble(type, html) {
  const div = document.createElement('div');
  const isStudent = type.includes('student');
  const isWrong   = type.includes('wrong');
  const isCorrect = type.includes('correct');
  div.className = 'bubble ' + (isStudent ? 'student' : 'tutor') + (isCorrect ? ' correct' : '') + (isWrong ? ' wrong' : '');
  const label = document.createElement('span');
  label.className = 'bub-label';
  label.textContent = isStudent ? 'You' : '🎤 Tutor';
  div.appendChild(label);
  const content = document.createElement('span');
  content.innerHTML = html;
  div.appendChild(content);
  $('chatArea').appendChild(div);
  $('chatArea').scrollTop = $('chatArea').scrollHeight;
}

function evaluateAnswer(transcript) {
  const target = convSentences[convIndex].en.toLowerCase().replace(/[.,!?;:]/g,'').trim();
  const said   = transcript.toLowerCase().replace(/[.,!?;:]/g,'').trim();
  const targetWords = target.split(' ').filter(w => w.length > 2);
  const saidWords   = said.split(' ');
  const matches = targetWords.filter(w => saidWords.some(s => s.includes(w) || w.includes(s)));
  const score = matches.length / targetWords.length;

  convAttempts++;
  addBubble('student', transcript);

  if (score >= 0.65) {
    convCompleted.push(convIndex);
    updateConvProgress();
    const praise = ['Great job! 🌟','Perfect! ✨','Excellent! 👏','Well done! 🎉','Spot on! 💯'][Math.floor(Math.random()*5)];
    addBubble('tutor correct', praise + (score < 0.9 ? ' Close enough!' : ''));
    $('repeatCard').style.display = 'none';
    $('playAgainBtn').style.display = 'none';
    $('micBtn').disabled = true; $('micBtn').style.opacity = '0.3';
    showMicStatus('', 'hint');
    $('transcriptPreview').textContent = '';
    convIndex++;
    if (convIndex < convSentences.length) {
      setTimeout(() => { addBubble('tutor', "Now let's try the next sentence."); setTimeout(() => presentSentence(), 1200); }, 1400);
    } else {
      setTimeout(() => convFinished(), 1400);
    }
  } else if (convAttempts >= 3) {
    addBubble('tutor wrong', `Not quite — the correct sentence is: <em>"${convSentences[convIndex].en}"</em>. Let's keep going!`);
    speakTutor(convSentences[convIndex].en, () => {
      $('repeatCard').style.display = 'none';
      $('playAgainBtn').style.display = 'none';
      $('micBtn').disabled = true; $('micBtn').style.opacity = '0.3';
      showMicStatus('', 'hint');
      convIndex++;
      if (convIndex < convSentences.length) {
        setTimeout(() => { addBubble('tutor', "Let's continue with the next one."); setTimeout(() => presentSentence(), 1200); }, 1800);
      } else {
        setTimeout(() => convFinished(), 1800);
      }
    });
  } else {
    const encouragement = ["Not quite — try again! 💪", "Almost! Give it another go.", "Keep trying, you are close!"][Math.min(convAttempts-1, 2)];
    addBubble('tutor wrong', encouragement);
    showMicStatus('Try again — press the mic', 'hint');
    $('transcriptPreview').textContent = '';
    speakTutor(convSentences[convIndex].en);
  }
}

function convFinished() {
  $('repeatCard').style.display = 'none';
  $('playAgainBtn').style.display = 'none';
  $('micBtn').disabled = true; $('micBtn').style.opacity = '0.3';
  showMicStatus('', 'hint');
  const correct = convCompleted.length;
  const total   = convSentences.length;
  const pct     = Math.round(correct/total*100);
  let msg;
  if (pct >= 80) msg = `Amazing work! You got ${correct} out of ${total} sentences correct (${pct}%). You are doing brilliantly! 🌟`;
  else if (pct >= 50) msg = `Good effort! You got ${correct} out of ${total} sentences (${pct}%). Keep practicing! 💪`;
  else msg = `You got ${correct} out of ${total} (${pct}%). Practice makes perfect! 📚`;
  addBubble('tutor', msg);
  speakTutor(msg);
  setTimeout(() => {
    const div = document.createElement('div');
    div.style.cssText = 'display:flex;gap:10px;justify-content:center;margin-top:8px;flex-wrap:wrap;';
    div.innerHTML = `
      <button onclick="startConv('${convTopic}')" style="padding:10px 22px;border-radius:99px;background:linear-gradient(135deg,#d4a843,#e8c870);color:#1c1510;font-weight:bold;font-family:Georgia,serif;border:none;cursor:pointer;font-size:14px;">Practice again</button>
      <button onclick="showScreen('Topic')" style="padding:10px 22px;border-radius:99px;background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.6);font-family:'Courier New',monospace;font-size:11px;letter-spacing:1px;border:1.5px solid rgba(255,255,255,0.1);cursor:pointer;">Change topic</button>
    `;
    $('chatArea').appendChild(div);
    $('chatArea').scrollTop = $('chatArea').scrollHeight;
  }, 2000);
}

function updateConvProgress() {
  const total = convSentences.length;
  const dots = $('convProgress');
  dots.innerHTML = '';
  for (let i = 0; i < total; i++) {
    const d = document.createElement('div');
    d.className = 'prog-dot' + (convCompleted.includes(i) ? ' done' : (i===convIndex ? ' current' : ''));
    dots.appendChild(d);
  }
}


/* ════════════════════════════════════════
   GAMIFICATION ENGINE
════════════════════════════════════════ */

// ── XP thresholds per level (level = index+1) ──
const XP_LEVELS = [0,50,120,220,360,550,800,1100,1500,2000,2600,3300,4100,5000,6000,7200,8500,10000,12000,15000];

function playerLevel() {
  for (var i = XP_LEVELS.length-1; i >= 0; i--) {
    if (xp >= XP_LEVELS[i]) return i+1;
  }
  return 1;
}
function xpForLevel(lvl) { return XP_LEVELS[Math.min(lvl-1, XP_LEVELS.length-1)] || 0; }
function xpToNextLevel(lvl) { return XP_LEVELS[Math.min(lvl, XP_LEVELS.length-1)] || XP_LEVELS[XP_LEVELS.length-1]; }

const LEVEL_TITLES = [
  '','Newcomer','Explorer','Learner','Curious One','Rising Star',
  'Word Seeker','Phrase Hunter','Grammar Scout','Language Apprentice','Story Teller',
  'Vocabulary Ace','Sentence Master','Grammar Wizard','Language Hero','Word Champion',
  'Fluency Knight','Scholar','Linguist Elite','Grand Master','English Legend'
];

// ── Completion tracking ──
// Stored keys: wf_done_a1, wf_done_b1, wf_done_c1, wf_done_gf, wf_games_*, wf_conv_*
function markDone(key) {
  var prev = localStorage.getItem('wf_done_'+key);
  if (!prev) {
    localStorage.setItem('wf_done_'+key, '1');
    return true; // first time
  }
  return false;
}
function isDone(key) { return !!localStorage.getItem('wf_done_'+key); }

function markGamePlayed(gameId) {
  var prev = localStorage.getItem('wf_game_'+gameId);
  if (!prev) { localStorage.setItem('wf_game_'+gameId, '1'); return true; }
  return false;
}
function isGamePlayed(gameId) { return !!localStorage.getItem('wf_game_'+gameId); }

function markConvDone(topic) {
  var prev = localStorage.getItem('wf_conv_'+topic);
  if (!prev) { localStorage.setItem('wf_conv_'+topic, '1'); return true; }
  return false;
}
function isConvDone(topic) { return !!localStorage.getItem('wf_conv_'+topic); }

// ── Achievement definitions ──
var ACHIEVEMENTS = [
  { id:'first_flip',   ico:'🃏', name:'First Flip',        desc:'Completed your first flashcard deck',   check:function(){ return isDone('a1')||isDone('b1')||isDone('c1'); } },
  { id:'deck_a1',      ico:'🌱', name:'Sprout',            desc:'Completed Grade 2–3 deck',              check:function(){ return isDone('a1'); } },
  { id:'deck_b1',      ico:'📖', name:'Bookworm',          desc:'Completed Grade 3–4 deck',              check:function(){ return isDone('b1'); } },
  { id:'deck_c1',      ico:'🎓', name:'Graduate',          desc:'Completed Grade 4–5 deck',              check:function(){ return isDone('c1'); } },
  { id:'all_decks',    ico:'💎', name:'Full Scholar',      desc:'Completed all three flashcard decks',   check:function(){ return isDone('a1')&&isDone('b1')&&isDone('c1'); } },
  { id:'grammar_done', ico:'📘', name:'Grammar Master',    desc:'Completed Grammar Flashcard practice',  check:function(){ return isDone('gf'); } },
  { id:'conv_first',   ico:'🎤', name:'First Words',       desc:'Completed a Conversation session',      check:function(){ return ['basketball','movies','sports','geography','languages'].some(isConvDone); } },
  { id:'conv_all',     ico:'🌍', name:'Polyglot',          desc:'Completed all 5 conversation topics',   check:function(){ return ['basketball','movies','sports','geography','languages'].every(isConvDone); } },
  { id:'game_first',   ico:'🎮', name:'Player One',        desc:'Played your first mini game',           check:function(){ return ['scramble','build','odd','quick','trans','spell','mahjong'].some(isGamePlayed); } },
  { id:'game_all',     ico:'🕹',  name:'Game Master',       desc:'Played every type of mini game',        check:function(){ return ['scramble','build','odd','quick','trans','spell','mahjong'].every(isGamePlayed); } },
  { id:'streak3',      ico:'🔥', name:'On Fire',           desc:'Reached a 3-day learning streak',       check:function(){ return streak>=3; } },
  { id:'streak7',      ico:'⚡', name:'Week Warrior',      desc:'Reached a 7-day streak',                check:function(){ return streak>=7; } },
  { id:'xp100',        ico:'⭐', name:'Century',           desc:'Earned 100 XP',                        check:function(){ return xp>=100; } },
  { id:'xp500',        ico:'🌟', name:'Star Collector',    desc:'Earned 500 XP',                        check:function(){ return xp>=500; } },
  { id:'xp1000',       ico:'👑', name:'XP Royalty',        desc:'Earned 1000 XP',                       check:function(){ return xp>=1000; } },
  { id:'level5',       ico:'🚀', name:'Level 5',           desc:'Reached Level 5',                      check:function(){ return playerLevel()>=5; } },
  { id:'level10',      ico:'💫', name:'Level 10',          desc:'Reached Level 10',                     check:function(){ return playerLevel()>=10; } },
];

function getEarnedAchievements() {
  return ACHIEVEMENTS.filter(function(a) { return localStorage.getItem('wf_ach_'+a.id); });
}

// Check all achievements and award any newly earned ones
function checkAchievements() {
  var newlyEarned = [];
  ACHIEVEMENTS.forEach(function(a) {
    if (!localStorage.getItem('wf_ach_'+a.id) && a.check()) {
      localStorage.setItem('wf_ach_'+a.id, '1');
      newlyEarned.push(a);
    }
  });
  // Show them sequentially
  if (newlyEarned.length) showAchievementQueue(newlyEarned, 0);
}

var achQueue = [], achShowing = false;
function showAchievementQueue(list, idx) {
  if (idx >= list.length) return;
  showAchievementToast(list[idx], function() {
    showAchievementQueue(list, idx+1);
  });
}

function showAchievementToast(ach, cb) {
  var toast = $('achToast');
  if (!toast) return;
  $('achToastIco').textContent  = ach.ico;
  $('achToastName').textContent = ach.name;
  $('achToastDesc').textContent = ach.desc;
  toast.classList.add('show');
  setTimeout(function() {
    toast.classList.remove('show');
    setTimeout(function() { if(cb) cb(); }, 500);
  }, 3200);
}

// ── Level-up detection ──
var _prevLevel = 1;
function checkLevelUp() {
  var lvl = playerLevel();
  if (lvl > _prevLevel) {
    _prevLevel = lvl;
    showLevelUp(lvl);
  }
}

function showLevelUp(lvl) {
  var overlay = document.createElement('div');
  overlay.className = 'levelup-overlay';
  var perks = getLevelPerk(lvl);
  overlay.innerHTML =
    '<div class="levelup-card">'
    + '<span class="levelup-emoji">✨</span>'
    + '<div class="levelup-tag">Level Up!</div>'
    + '<div class="levelup-num">'+lvl+'</div>'
    + '<div class="levelup-title">'+LEVEL_TITLES[Math.min(lvl,20)]+'</div>'
    + '<div class="levelup-perk">'+perks+'</div>'
    + '<button class="levelup-btn" onclick="this.closest(\'.levelup-overlay\').remove()">Keep going! 🚀</button>'
    + '</div>';
  document.body.appendChild(overlay);
}

function getLevelPerk(lvl) {
  var perks = {
    2:  'You unlocked: Sentence Builder game!',
    3:  'You unlocked: Translation Match!',
    4:  'You unlocked: Spelling Bee!',
    5:  'You unlocked: Quick Fire timed mode!',
    7:  'You unlocked: Word Mahjong!',
    10: 'You are halfway to Legend status. Keep it up!',
    15: 'Only 5 levels left. You\'re almost a Legend!',
    20: 'You\'ve reached the highest rank: English Legend!',
  };
  return perks[lvl] || 'Keep learning — more badges await!';
}

// ── Updated awardXP that checks level-up ──
var _origAwardXP = awardXP;
awardXP = function(amount, x, y) {
  var before = playerLevel();
  xp += amount;
  var today = new Date().toDateString();
  if (lastPlay !== today) { streak++; lastPlay = today; }
  saveXP();
  var burst = document.createElement('div');
  burst.className = 'xp-burst';
  burst.textContent = '+' + amount + ' XP';
  burst.style.cssText = 'left:'+(x||window.innerWidth/2)+'px;top:'+(y||200)+'px;';
  document.body.appendChild(burst);
  setTimeout(function() { burst.remove(); }, 1300);
  // Check level up
  var after = playerLevel();
  if (after > before) { _prevLevel = before; checkLevelUp(); }
  checkAchievements();
};

// ── Hook into deck completion ──
var _origShowDone = showDone;
showDone = function() {
  _origShowDone();
  var isFirst = markDone(lv);
  var xpReward = lv === 'c1' ? 40 : lv === 'b1' ? 30 : 20;
  awardXP(xpReward, window.innerWidth/2, 200);
  updateLcardBadges();
  checkAchievements();
  // Enrich the done screen
  setTimeout(function() {
    var dt = $('doneTxt');
    if (dt) {
      dt.innerHTML += '<br><br><span style="font-family:\'Courier New\',monospace;font-size:12px;color:#e8c870;letter-spacing:1px;">+'+ xpReward +' XP earned' + (isFirst ? ' · 🏅 First completion!' : '') + '</span>';
    }
  }, 100);
};

// ── Hook into grammar flash completion ──
var _origRenderGFSummary = renderGFSummary;
renderGFSummary = function() {
  _origRenderGFSummary();
  markDone('gf');
  checkAchievements();
};

// ── Hook into challenge summary ──
var _origShowChalSummary = showChalSummary;
showChalSummary = function() {
  markGamePlayed(chalType);
  _origShowChalSummary();
  checkAchievements();
};

// ── Hook into conversation completion ──
// convFinished is called at end of conversation
var _origConvFinished = convFinished;
convFinished = function() {
  if (typeof currentTopic !== 'undefined' && currentTopic) {
    markConvDone(currentTopic);
  }
  _origConvFinished();
  checkAchievements();
};

// ── Update lcard badges ──
function updateLcardBadges() {
  ['a1','b1','c1'].forEach(function(key) {
    var el = $('badge_'+key);
    if (!el) return;
    if (isDone(key)) {
      el.style.display = 'block';
      el.textContent = '✅';
    }
  });
}

// ── Update level display in header ──
function updateLevelDisplay() {
  var el = $('headerLevel');
  if (el) el.textContent = 'Lv ' + playerLevel();
  updateLcardBadges();
}

// ── Build profile screen ──
function buildProfileScreen() {
  updateLevelDisplay();
  var lvl = playerLevel();
  var curXP = xp;
  var lvlXP = xpForLevel(lvl);
  var nxtXP = xpToNextLevel(lvl);
  var pct = lvl >= 20 ? 100 : Math.round((curXP - lvlXP) / (nxtXP - lvlXP) * 100);
  var earned = getEarnedAchievements();

  // Progress items
  var deckRows = [
    { ico:'🌱', name:'Grade 2–3 Flashcards', key:'a1', total:10 },
    { ico:'📖', name:'Grade 3–4 Flashcards', key:'b1', total:10 },
    { ico:'🎓', name:'Grade 4–5 Flashcards', key:'c1', total:10 },
    { ico:'📘', name:'Grammar Practice',     key:'gf', total:1  },
  ];
  var convRows = [
    { ico:'🏀', name:'Basketball',  key:'basketball' },
    { ico:'🎬', name:'Movies',      key:'movies' },
    { ico:'⚽', name:'Sports',      key:'sports' },
    { ico:'🌍', name:'Geography',   key:'geography' },
    { ico:'💬', name:'Languages',   key:'languages' },
  ];
  var gameRows = CHALLENGE_TYPES.map(function(ct) {
    return { ico:ct.ico, name:ct.name, key:ct.id };
  });

  function makeProgCard(ico, name, done, pct, meta) {
    return '<div class="prog-card'+(done?' done':'') + '">'
      + '<div class="prog-card-ico">'+ico+'</div>'
      + '<div class="prog-card-body">'
      +   '<div class="prog-card-name">'+name+'</div>'
      +   '<div class="prog-card-bar"><div class="prog-card-fill" style="width:'+pct+'%"></div></div>'
      +   '<div class="prog-card-meta">'+meta+'</div>'
      + '</div>'
      + '<div class="prog-card-check">'+(done?'✅':'⬜')+'</div>'
      + '</div>';
  }

  var deckHTML = deckRows.map(function(r) {
    var done = isDone(r.key);
    return makeProgCard(r.ico, r.name, done, done?100:0, done?'Completed':'Not yet started');
  }).join('');

  var convHTML = convRows.map(function(r) {
    var done = isConvDone(r.key);
    return makeProgCard(r.ico, r.name, done, done?100:0, done?'Completed':'Not yet started');
  }).join('');

  var gameHTML = gameRows.map(function(r) {
    var done = isGamePlayed(r.key);
    return makeProgCard(r.ico, r.name, done, done?100:0, done?'Played':'Not yet tried');
  }).join('');

  // Achievement badges
  var achHTML = ACHIEVEMENTS.map(function(a) {
    var e = !!localStorage.getItem('wf_ach_'+a.id);
    return '<div class="ach-badge'+(e?' earned':' locked')+'" title="'+a.desc+'">'
      + '<span class="ab-ico">'+a.ico+'</span>'
      + '<div class="ab-name">'+a.name+'</div>'
      + '<div class="ab-desc">'+a.desc+'</div>'
      + '</div>';
  }).join('');

  $('profileContent').innerHTML =
    // Hero card
    '<div class="profile-hero">'
    + '<div class="ph-avatar">'+getAvatarEmoji(lvl)+'</div>'
    + '<div class="ph-name">'+(userName||'Explorer')+'</div>'
    + '<div class="ph-level">Level '+lvl+' · '+LEVEL_TITLES[Math.min(lvl,20)]+'</div>'
    + '<div class="ph-xp-wrap">'
    +   '<div class="ph-xp-top"><span>XP Progress</span><span>'+curXP+' / '+nxtXP+' XP</span></div>'
    +   '<div class="ph-xp-track"><div class="ph-xp-fill" style="width:'+pct+'%"></div></div>'
    + '</div>'
    + '<div class="ph-stats-row">'
    +   '<div class="ph-stat"><div class="sv">'+curXP+'</div><div class="sl">Total XP</div></div>'
    +   '<div class="ph-stat"><div class="sv">'+streak+'</div><div class="sl">Streak 🔥</div></div>'
    +   '<div class="ph-stat"><div class="sv">'+earned.length+'/'+ACHIEVEMENTS.length+'</div><div class="sl">Badges</div></div>'
    + '</div>'
    + '</div>'
    // Decks
    + '<div class="profile-section"><div class="profile-section-title">Flashcard Decks</div></div>'
    + '<div class="prog-cards">'+deckHTML+'</div>'
    // Conversations
    + '<div class="profile-section"><div class="profile-section-title">Conversations</div></div>'
    + '<div class="prog-cards">'+convHTML+'</div>'
    // Games
    + '<div class="profile-section"><div class="profile-section-title">Mini Games</div></div>'
    + '<div class="prog-cards">'+gameHTML+'</div>'
    // Achievements
    + '<div class="profile-section"><div class="profile-section-title">Achievements ('+earned.length+' / '+ACHIEVEMENTS.length+')</div></div>'
    + '<div class="ach-grid">'+achHTML+'</div>';
}

function getAvatarEmoji(lvl) {
  if (lvl >= 18) return '👑';
  if (lvl >= 14) return '🧙';
  if (lvl >= 10) return '🦸';
  if (lvl >= 6)  return '🧑‍🎓';
  if (lvl >= 3)  return '🌱';
  return '🐣';
}



// Init gamification
_prevLevel = playerLevel(); updateLcardBadges(); updateLevelDisplay();
</script>
</body>
</html>
